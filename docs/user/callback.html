<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkedIn Authentication Callback</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 40px 20px;
            background-color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 500px;
            padding: 30px;
            text-align: center;
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 119, 181, 0.2);
            border-radius: 50%;
            border-top-color: #0077b5;
            animation: spin 1s infinite linear;
            margin: 20px auto;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .status-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
        }
        .error {
            background-color: #ffebee;
            color: #c62828;
        }
        .success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>LinkedIn Authentication</h2>
        <div id="loading">
            <div class="loading-spinner"></div>
            <p>Processing your LinkedIn authorization...</p>
        </div>
        <div id="statusMessage" class="status-message" style="display: none;"></div>
    </div>

    <script>
        // Parse query parameters
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const error = urlParams.get('error');
        const state = urlParams.get('state');
        
        // Parse state if it exists (contains conference info)
        let conferenceData = {};
        try {
            if (state) {
                conferenceData = JSON.parse(state);
                console.log('Parsed conference data from state:', conferenceData);
                
                // Store conference info in localStorage
                if (conferenceData.conferenceId) {
                    localStorage.setItem('conferenceId', conferenceData.conferenceId);
                }
                if (conferenceData.conferenceName) {
                    localStorage.setItem('conferenceName', conferenceData.conferenceName);
                }
                if (conferenceData.conferenceLocation) {
                    localStorage.setItem('conferenceLocation', conferenceData.conferenceLocation);
                }
            }
        } catch (e) {
            console.error('Error parsing state:', e);
        }

        // If there is an error, show it and redirect after delay
        if (error) {
            document.getElementById('loading').style.display = 'none';
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.style.display = 'block';
            statusMessage.classList.add('error');
            statusMessage.innerHTML = `
                <p><strong>Authentication Error</strong></p>
                <p>${error}</p>
                <p>Redirecting back to login...</p>
            `;
            
            // Redirect back to auth page after 3 seconds
            setTimeout(() => {
                window.location.href = 'auth.html';
            }, 3000);
        } 
        // If we have an authorization code
        else if (code) {
            console.log('Received authorization code from LinkedIn');
            
            // For direct implementation, we'll use a mock/direct auth without calling backend 
            // (will be replaced with actual backend call in production)
            mockLinkedInProfile(code)
                .then(profile => {
                    // Mark as authenticated
                    localStorage.setItem('isAuthenticated', 'true');
                    localStorage.setItem('authTime', new Date().toISOString());
                    
                    // Store LinkedIn profile data
                    localStorage.setItem('linkedInUser', JSON.stringify(profile));
                    
                    // Show success message
                    document.getElementById('loading').style.display = 'none';
                    const statusMessage = document.getElementById('statusMessage');
                    statusMessage.style.display = 'block';
                    statusMessage.classList.add('success');
                    statusMessage.innerHTML = `
                        <p><strong>Success!</strong></p>
                        <p>You've been authenticated with LinkedIn.</p>
                        <p>Redirecting to conference connections...</p>
                    `;
                    
                    // Redirect to connections page after a short delay
                    setTimeout(() => {
                        window.location.href = 'connections.html';
                    }, 1500);
                })
                .catch(error => {
                    console.error('Auth error:', error);
                    document.getElementById('loading').style.display = 'none';
                    const statusMessage = document.getElementById('statusMessage');
                    statusMessage.style.display = 'block';
                    statusMessage.classList.add('error');
                    statusMessage.innerHTML = `
                        <p><strong>Authentication Error</strong></p>
                        <p>${error.message || 'Unknown error occurred'}</p>
                        <p>Redirecting back to login...</p>
                    `;
                    
                    // Redirect back to auth page after error
                    setTimeout(() => {
                        window.location.href = 'auth.html';
                    }, 3000);
                });
        } else {
            // No code or error, redirect back to auth page
            document.getElementById('loading').style.display = 'none';
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.style.display = 'block';
            statusMessage.classList.add('error');
            statusMessage.innerHTML = `
                <p><strong>Missing Authorization Code</strong></p>
                <p>No authorization code was received from LinkedIn.</p>
                <p>Redirecting back to login...</p>
            `;
            
            // Redirect back to auth page
            setTimeout(() => {
                window.location.href = 'auth.html';
            }, 2000);
        }
        
        // Mock function to simulate getting profile data from LinkedIn
        // In a real implementation, this would call your backend API
        async function mockLinkedInProfile(code) {
            console.log('Processing auth code:', code.substring(0, 10) + '...');
            
            // Generate a random user profile or use a fixed one for testing
            const testUsernames = ['testuser', 'johndoe', 'janedoe', 'techuser'];
            const randomUsername = testUsernames[Math.floor(Math.random() * testUsernames.length)];
            
            // Mock delay to simulate API call
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // This provides realistic profile data based on the r_basicprofile permission
            const profile = {
                id: 'linkedin_' + Math.random().toString(36).substring(2, 10),
                firstName: urlParams.get('firstName') || 'Batman',
                lastName: urlParams.get('lastName') || 'Jojo',
                name: (urlParams.get('firstName') || 'Batman') + ' ' + (urlParams.get('lastName') || 'Jojo'),
                email: `${randomUsername}@example.com`,
                headline: 'Software Developer',
                // IMPORTANT: Set the LinkedIn public profile URL
                publicProfileUrl: `https://www.linkedin.com/in/${randomUsername}`,
                pictureUrl: `https://randomuser.me/api/portraits/lego/${Math.floor(Math.random() * 8)}.jpg`,
                // Include conference data from state
                conference: conferenceData
            };
            
            console.log('Created profile with PUBLIC PROFILE URL:', profile.publicProfileUrl);
            
            return profile;
        }
    </script>
</body>
</html>
