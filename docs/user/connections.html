<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conference Connections</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background-color: #0077b5;
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: 8px 8px 0 0;
        }
        .header h1 {
            margin: 0;
            font-size: 20px;
        }
        .conference-info {
            background-color: white;
            border-radius: 0 0 8px 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .user-profile {
            display: flex;
            align-items: center;
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .profile-image {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 20px;
        }
        .profile-info h2 {
            margin: 0 0 5px 0;
            font-size: 18px;
        }
        .profile-info p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
        .section-title {
            margin: 30px 0 15px 0;
            font-size: 18px;
            color: #0077b5;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .section-title .refresh-btn {
            background-color: transparent;
            color: #0077b5;
            border: 1px solid #0077b5;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 14px;
            cursor: pointer;
        }
        .section-title .refresh-btn:hover {
            background-color: rgba(0, 119, 181, 0.1);
        }
        .connections-list {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .connection-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }
        .connection-item:last-child {
            border-bottom: none;
        }
        .connection-img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
        }
        .connection-info {
            flex: 1;
        }
        .connection-info h3 {
            margin: 0 0 5px 0;
            font-size: 16px;
        }
        .connection-info p {
            margin: 0;
            color: #666;
            font-size: 13px;
        }
        .connection-info .mutual {
            margin-top: 5px;
            font-size: 12px;
            color: #0077b5;
        }
        .connection-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }
        .btn {
            background-color: #0077b5;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            transition: background-color 0.3s;
        }
        .btn i {
            margin-right: 5px;
        }
        .btn:hover {
            background-color: #006097;
        }
        .btn-outline {
            background-color: transparent;
            color: #0077b5;
            border: 1px solid #0077b5;
        }
        .btn-outline:hover {
            background-color: rgba(0, 119, 181, 0.1);
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        .empty-state i {
            font-size: 50px;
            color: #ccc;
            margin-bottom: 15px;
        }
        .logout-btn {
            background-color: transparent;
            color: white;
            border: 1px solid white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .search-container {
            margin-bottom: 15px;
        }
        .search-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Montserrat', sans-serif;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 119, 181, 0.2);
            border-radius: 50%;
            border-top-color: #0077b5;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .conference-context {
            padding: 15px;
            background-color: #f0f7ff;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .conference-context h3 {
            margin: 0 0 10px 0;
            color: #0077b5;
        }
        .conference-context p {
            margin: 0;
            color: #555;
        }
        .search-results-info {
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .search-results-info p {
            margin: 0;
            font-style: italic;
            color: #666;
        }
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            .connection-actions {
                flex-direction: column;
                gap: 5px;
            }
        }
        /* Visibility Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin-right: 10px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
        }

        input:checked + .slider {
            background-color: #0077b5;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        .visibility-settings {
            display: flex;
            align-items: center;
            padding: 5px 0;
        }
        @keyframes fadeOut {
            0% { opacity: 1; }
            70% { opacity: 1; }
            100% { opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="container">
        <div class="header">
            <h1><i class="fab fa-linkedin"></i> LinkedIn Conference Connections</h1>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
        
        <!-- Debug panel to show actual storage data -->
        <div style="background-color: #f8f8f8; border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
            <h3 style="margin-top: 0; color: #333;">Storage Debug Info</h3>
            <div id="debug-info" style="font-family: monospace; font-size: 12px; white-space: pre-wrap;"></div>
            <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="refreshPage()" style="padding: 5px 10px; background: #0077b5; color: white; border: none; border-radius: 4px;">Refresh Page</button>
                <button onclick="fixTestData()" style="padding: 5px 10px; background: #28a745; color: white; border: none; border-radius: 4px;">Fix with Test Data</button>
                <button onclick="testLinkedInFormat()" style="padding: 5px 10px; background: #6f42c1; color: white; border: none; border-radius: 4px;">Test LinkedIn API Format</button>
                <button onclick="testLinkedInOAuth()" style="padding: 5px 10px; background: #fd7e14; color: white; border: none; border-radius: 4px;">Test LinkedIn OAuth</button>
                <button onclick="clearAllData()" style="padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px;">Clear All Data</button>
                <button onclick="goToAuth()" style="padding: 5px 10px; background: #f0ad4e; color: white; border: none; border-radius: 4px;">Go to Auth Page</button>
                <button onclick="bypassAuthCheck()" style="padding: 5px 10px; background: #5bc0de; color: white; border: none; border-radius: 4px;">Bypass Auth Check</button>
            </div>
        </div>
        
        <div class="conference-info">
            <h2 id="conference-name">Loading conference info...</h2>
            <p id="conference-location"></p>
            <p><small>Showing LinkedIn connections attending this conference</small></p>
        </div>
        
        <div class="user-profile">
            <img id="profile-image" class="profile-image" src="https://randomuser.me/api/portraits/men/1.jpg" alt="Profile Image">
            <div class="profile-info">
                <h2 id="profile-name">Loading profile...</h2>
                <p id="profile-email"></p>
                <p id="profile-headline" style="margin-top: 5px;"></p>
                <div class="visibility-settings" style="margin-top: 10px;">
                    <label class="switch">
                        <input type="checkbox" id="visibility-toggle" onchange="updateVisibility(this.checked)">
                        <span class="slider round"></span>
                    </label>
                    <span id="visibility-status">Visible to Other Attendees</span>
                </div>
            </div>
        </div>
        
        <div class="search-container">
            <input type="text" class="search-input" placeholder="Search connections..." id="searchInput">
        </div>
        
        <h2 class="section-title">
            All Conference Attendees
            <button class="refresh-btn" onclick="refreshConnections()"><i class="fas fa-sync-alt"></i> Refresh</button>
        </h2>
        
        <div class="connections-list" id="connections-list">
            <!-- Will be populated dynamically -->
            <div class="empty-state">
                <i class="fas fa-users"></i>
                <p>Fetching your LinkedIn connections at this conference...</p>
                <p>This may take a few moments.</p>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const apiConfig = {
            baseUrl: 'https://cholebhature.netlify.app/api',
            endpoints: {
                // LinkedIn endpoints
                profile: '/linkedin/profile',
                connections: '/linkedin/connections',
                picture: '/linkedin/picture',
                
                // Conference endpoints
                conferenceAttendees: '/conference',
                conferenceRegister: '/conference/register',
                conferenceVisibility: '/conference/visibility',
                conferenceRecommendations: '/conference/recommendations'
            }
        };

        // Function to get full API URL
        function getApiUrl(endpoint, params = {}) {
            // Ensure the endpoint starts with a slash
            if (!endpoint.startsWith('/')) {
                endpoint = '/' + endpoint;
            }
            
            let url = `${apiConfig.baseUrl}${endpoint}`;
            
            // Add parameters if provided
            if (Object.keys(params).length > 0) {
                const queryParams = new URLSearchParams();
                for (const [key, value] of Object.entries(params)) {
                    queryParams.append(key, value);
                }
                const queryString = queryParams.toString();
                url = queryString ? `${url}?${queryString}` : url;
            }
            
            console.log('Generated API URL:', url);
            return url;
        }

        // Function to automatically refresh connections periodically
        let autoRefreshInterval = null;

        // Initialize the page
        async function initializePage() {
            try {
                console.log('Initializing page...');
                
                // Check if user is authenticated
                const userData = localStorage.getItem('linkedInUser');
                if (!userData) {
                    console.error('No user data found, redirecting to auth page');
                    window.location.href = 'auth.html';
                    return;
                }
                
                // Check if conference info is set
                const conferenceId = localStorage.getItem('conferenceId');
                if (!conferenceId) {
                    console.error('No conference ID found');
                    alert('Conference ID is missing. Please try again with a valid conference link.');
                    return;
                }
                
                // Display user profile first
                displayUserProfile();
                
                // Hide loading overlay immediately
                document.getElementById('loadingOverlay').style.display = 'none';
                
                // Force register user multiple times to ensure we're in the system
                try {
                    console.log('Pre-registering for conference...');
                    
                    // Try registration several times with delays
                    const registerResult = await registerForConference();
                    console.log('First registration result:', registerResult);
                    
                    // Wait and try again to ensure it's processed
                    await new Promise(resolve => setTimeout(resolve, 500));
                    const registerResult2 = await registerForConference();
                    console.log('Second registration result:', registerResult2);
                    
                    // Final registration attempt
                    await new Promise(resolve => setTimeout(resolve, 500));
                    const registerResult3 = await registerForConference();
                    console.log('Third registration result:', registerResult3);
                    
                } catch (regError) {
                    console.error('Error during pre-registration:', regError);
                }
                
                // Generate and display connections
                const connections = await generateConnections();
                displayConnections(connections);
                
                // Initialize visibility
                initializeVisibility();
                
                // Get server debug info
                const debugInfo = await fetchDebugInfo();
                updateDebugPanel(debugInfo);
                
                // Set up auto-refresh
                startAutoRefresh(15000); // Every 15 seconds
                
                console.log('Page initialization complete.');
            } catch (error) {
                console.error('Error initializing page:', error);
                document.getElementById('loadingOverlay').style.display = 'none';
                alert('Error loading connections. Please try refreshing the page.');
            }
        }

        // Start automatic refresh - but use a longer interval
        function startAutoRefresh(intervalMs = 30000) { // Every 30 seconds
            // Clear any existing interval
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            // Set new interval for auto-refresh
            console.log(`Starting auto-refresh with interval: ${intervalMs}ms`);
            
            autoRefreshInterval = setInterval(async () => {
                console.log('Auto-refreshing connections...');
                try {
                    // Silently refresh without showing loading overlay
                    const connections = await generateConnections(true);
                    
                    // Also update debug info
                    const debugInfo = await fetchDebugInfo();
                    updateDebugPanel(debugInfo);
                    
                    // If connections are different from current list, update the display
                    const currentCount = allConnections ? allConnections.length : 0;
                    
                    if (connections.length !== currentCount) {
                        console.log(`Updating connections: was ${currentCount}, now ${connections.length}`);
                        displayConnections(connections);
                        
                        // Show a small notification that new attendees were found
                        if (connections.length > currentCount) {
                            const newCount = connections.length - currentCount;
                            const refreshIndicator = document.createElement('div');
                            refreshIndicator.className = 'visibility-indicator';
                            refreshIndicator.style.cssText = `
                                position: fixed;
                                top: 20px;
                                right: 20px;
                                background-color: #28a745;
                                color: white;
                                padding: 10px 20px;
                                border-radius: 4px;
                                z-index: 1000;
                                animation: fadeOut 3s forwards;
                            `;
                            refreshIndicator.textContent = `Found ${newCount} new attendee${newCount === 1 ? '' : 's'}`;
                            document.body.appendChild(refreshIndicator);
                            
                            // Remove the indicator after animation
                            setTimeout(() => refreshIndicator.remove(), 3000);
                        }
                    }
                } catch (error) {
                    console.warn('Auto-refresh error:', error);
                    // Don't show error to user, just log it
                }
            }, intervalMs);
        }

        // Stop automatic refresh
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        // Function to generate connections from LinkedIn API
        async function generateConnections(silent = false) {
            const conferenceId = localStorage.getItem('conferenceId');
            const currentUserId = JSON.parse(localStorage.getItem('linkedInUser')).id;
            
            console.log('Generating connections for:', {
                conferenceId,
                currentUserId,
                silent
            });
            
            try {
                // First, ensure user is registered for the conference
                console.log('Registering for conference...');
                await registerForConference();
                
                // Wait a moment to ensure registration is processed
                await new Promise(resolve => setTimeout(resolve, 800));
                
                // Try both API formats
                const netlifyFormat = `/.netlify/functions/conference-attendees?conferenceId=${encodeURIComponent(conferenceId)}&currentUserId=${encodeURIComponent(currentUserId)}&_t=${Date.now()}`;
                const standardFormat = `/api/conference?conferenceId=${encodeURIComponent(conferenceId)}&currentUserId=${encodeURIComponent(currentUserId)}&_t=${Date.now()}`;
                
                console.log('Trying both API formats for attendees');
                console.log('Netlify format:', netlifyFormat);
                console.log('Standard format:', standardFormat);
                
                // Show loading overlay while fetching if not silent
                if (!silent) {
                    document.getElementById('loadingOverlay').style.display = 'flex';
                }
                
                // Try both API paths to ensure we get data
                let attendeesData = null;
                
                // Try Netlify format first
                try {
                    const response = await fetch(netlifyFormat, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Cache-Control': 'no-cache, no-store'
                        }
                    });
                    
                    if (response.ok) {
                        attendeesData = await response.json();
                        console.log('Netlify format succeeded:', attendeesData);
                    } else {
                        console.warn('Netlify format failed, status:', response.status);
                    }
                } catch (netlifyError) {
                    console.error('Error with Netlify format:', netlifyError);
                }
                
                // If Netlify format failed, try standard format
                if (!attendeesData) {
                    try {
                        const response = await fetch(standardFormat, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                                'Cache-Control': 'no-cache, no-store'
                            }
                        });
                        
                        if (response.ok) {
                            attendeesData = await response.json();
                            console.log('Standard format succeeded:', attendeesData);
                        } else {
                            console.warn('Standard format failed, status:', response.status);
                        }
                    } catch (standardError) {
                        console.error('Error with Standard format:', standardError);
                    }
                }
                
                // If both API calls failed, try direct approach through debug store
                if (!attendeesData) {
                    console.log('Both API formats failed, trying direct debug store access');
                    const directUrl = `/.netlify/functions/debug-store?action=get_conference_attendees&conferenceId=${encodeURIComponent(conferenceId)}`;
                    
                    try {
                        const directResponse = await fetch(directUrl);
                        if (directResponse.ok) {
                            attendeesData = await directResponse.json();
                            console.log('Direct debug store access succeeded:', attendeesData);
                        } else {
                            console.warn('Direct debug store access failed, status:', directResponse.status);
                        }
                    } catch (directError) {
                        console.error('Error with direct debug store access:', directError);
                    }
                }
                
                // If we still don't have data, load a fallback for demo purposes
                if (!attendeesData || !attendeesData.attendees || attendeesData.attendees.length === 0) {
                    // Register self for display if no other attendees
                    console.log('No attendee data available, creating local placeholder');
                    
                    // Create placeholder based on current user
                    const userData = JSON.parse(localStorage.getItem('linkedInUser'));
                    // Always include the current user
                    const placeholderAttendees = [{
                        id: userData.id,
                        isVisible: true,
                        profile: {
                            id: userData.id,
                            name: userData.name || `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || 'Current User',
                            title: userData.headline || userData.title || 'Conference Attendee',
                            company: userData.company || '',
                            profilePicture: userData.profilePicture || userData.pictureUrl || userData.picture || ''
                        }
                    }];
                    
                    attendeesData = {
                        conferenceId: conferenceId,
                        attendees: placeholderAttendees
                    };
                    
                    console.log('Created placeholder attendee data:', attendeesData);
                }
                
                console.log('Final attendees data:', JSON.stringify(attendeesData, null, 2));
                
                // Extract attendees from the response
                const attendees = attendeesData.attendees || [];
                console.log(`Processing ${attendees.length} attendees`);
                
                // Process and return the attendees 
                return processAttendees(attendees);
            } catch (error) {
                console.error('Error generating connections:', error);
                
                // Return empty array
                return [];
            } finally {
                // Hide loading overlay if not silent
                if (!silent) {
                    document.getElementById('loadingOverlay').style.display = 'none';
                }
            }
        }

        // Helper function to process attendees data into connection format
        function processAttendees(attendees) {
            // Make sure attendees is an array
            if (!Array.isArray(attendees)) {
                console.error('Attendees is not an array:', attendees);
                attendees = [];
            }
            
            // If empty array, return empty list
            if (attendees.length === 0) {
                console.log('No attendees to process');
                return [];
            }
            
            console.log('Processing attendees:', attendees);
            
            // Current user ID for reference
            const currentUserId = JSON.parse(localStorage.getItem('linkedInUser')).id;
            console.log('Current user ID:', currentUserId);
            
            // Make sure current user is represented
            let hasCurrentUser = false;
            
            // Process all attendees, including current user
            const processedAttendees = attendees.map(attendee => {
                // Extract the ID from the attendee object
                const attendeeId = attendee.id || attendee.profile?.id;
                
                // Check if this is the current user
                if (attendeeId === currentUserId) {
                    hasCurrentUser = true;
                }
                
                // Log for debugging
                console.log(`Processing attendee: ${attendeeId} (${attendee.profile?.name || 'unnamed'})`);

                // Handle both data formats - profile might be nested or direct
                const profile = attendee.profile || attendee;
                
                // Get name - prefer complete name over firstname/lastname combination
                let name = profile.name;
                if (!name && (profile.firstName || profile.lastName)) {
                    name = `${profile.firstName || ''} ${profile.lastName || ''}`.trim();
                }
                
                // Only use a placeholder as absolute last resort
                if (!name) {
                    name = 'Conference Attendee';
                }
                
                // Get professional headline - avoid using "LinkedIn User" placeholder
                let title = profile.headline || profile.title || profile.currentPosition?.title;
                if (!title) {
                    title = profile.company ? `Professional at ${profile.company}` : 'Professional';
                }
                
                // Get company name
                const company = profile.company || profile.currentPosition?.companyName || '';
                
                // Get profile URL or create a search URL
                let profileUrl;
                if (profile.vanityName && !profile.vanityName.match(/^[A-Z0-9]{8,12}$/i)) {
                    profileUrl = `https://www.linkedin.com/in/${profile.vanityName}`;
                } else if (profile.publicProfileUrl && profile.publicProfileUrl.includes('/in/')) {
                    profileUrl = profile.publicProfileUrl;
                } else {
                    profileUrl = `search:${attendee.id || profile.id}`;
                }
                
                // Get profile picture with fallbacks
                let pictureUrl = profile.profilePicture || profile.pictureUrl || profile.picture;
                
                // If the profile picture is a complex object (LinkedIn API format)
                if (typeof pictureUrl === 'object' && pictureUrl?.['displayImage~']?.elements?.[0]?.identifiers?.[0]?.identifier) {
                    pictureUrl = pictureUrl['displayImage~'].elements[0].identifiers[0].identifier;
                }
                
                // Use a random avatar if no picture is available
                if (!pictureUrl) {
                    const randomId = Math.floor(Math.random() * 100);
                    pictureUrl = `https://randomuser.me/api/portraits/people/${randomId}.jpg`;
                }
                
                // Generate last active time (random between 1-60 minutes)
                const lastActive = Math.floor(Math.random() * 60) + 1;
                        
                return {
                    id: attendee.id || profile.id,
                    name: name,
                    title: title,
                    company: company,
                    pictureUrl: pictureUrl,
                    profileUrl: profileUrl,
                    lastActive: lastActive,
                    profile: profile
                };
            });
            
            // Add current user if not already in the list
            if (!hasCurrentUser) {
                console.log('Adding current user to attendee list');
                const userData = JSON.parse(localStorage.getItem('linkedInUser'));
                
                // Create display name
                let userName = userData.name;
                if (!userName && (userData.firstName || userData.lastName)) {
                    userName = `${userData.firstName || ''} ${userData.lastName || ''}`.trim();
                }
                if (!userName && (userData.given_name || userData.family_name)) {
                    userName = `${userData.given_name || ''} ${userData.family_name || ''}`.trim();
                }
                
                // Create headline
                let userTitle = userData.headline || userData.title;
                if (!userTitle) {
                    userTitle = userData.company ? `Professional at ${userData.company}` : 'Conference Attendee';
                }
                
                // Create picture URL
                let userPicture = userData.profilePicture || userData.pictureUrl || userData.picture;
                if (typeof userPicture === 'object' && userPicture?.['displayImage~']?.elements?.[0]?.identifiers?.[0]?.identifier) {
                    userPicture = userPicture['displayImage~'].elements[0].identifiers[0].identifier;
                }
                if (!userPicture) {
                    userPicture = 'https://randomuser.me/api/portraits/people/1.jpg';
                }
                
                // Add current user to processed attendees
                processedAttendees.push({
                    id: currentUserId,
                    name: userName || 'You',
                    title: userTitle,
                    company: userData.company || '',
                    pictureUrl: userPicture,
                    profileUrl: 'https://www.linkedin.com/feed/',
                    lastActive: 0, // Always "just now"
                    profile: userData
                });
            }
            
            return processedAttendees;
        }

        // Function to display connections
        function displayConnections(connections, searchQuery = '') {
            console.log('Displaying connections:', {
                totalConnections: connections.length,
                searchQuery
            });
            
            // Store in global variable for use with search and other functions
            allConnections = connections;
            
            const connectionsList = document.getElementById('connections-list');
            
            // Clear existing connections
            connectionsList.innerHTML = '';
            
            // Get debug data to show in the debug panel
            fetchDebugInfo().then(debugInfo => {
                updateDebugPanel(debugInfo);
            });
            
            // Add welcome message and conference context
            const welcomeMessage = document.createElement('div');
            welcomeMessage.className = 'conference-context';
            
            const userName = document.getElementById('profile-name').textContent;
            
            welcomeMessage.innerHTML = `
                <h3>Welcome, ${userName}!</h3>
                <p>Conference: "${conferenceName}"</p>
                <p>${connections.length > 0 
                    ? `Showing ${connections.length} attendee${connections.length === 1 ? '' : 's'}` 
                    : 'No other attendees found yet'}
                </p>
            `;
            connectionsList.appendChild(welcomeMessage);
            
            // Filter connections based on search query if provided
            let filteredConnections = connections;
            if (searchQuery && searchQuery.trim() !== '') {
                const query = searchQuery.toLowerCase();
                filteredConnections = connections.filter(conn => 
                    conn.name.toLowerCase().includes(query) || 
                    conn.title.toLowerCase().includes(query) ||
                    conn.company.toLowerCase().includes(query)
                );
                
                // Add search results heading
                const searchHeading = document.createElement('div');
                searchHeading.className = 'search-results-info';
                searchHeading.innerHTML = `<p>Found ${filteredConnections.length} matching attendee(s) for "${searchQuery}"</p>`;
                connectionsList.appendChild(searchHeading);
            }
            
            if (filteredConnections.length === 0) {
                // No connections found, show appropriate message
                if (connections.length > 0 && searchQuery) {
                    // We have connections but search returned no results
                    connectionsList.innerHTML += `
                        <div class="empty-state">
                            <i class="fas fa-search"></i>
                            <p>No attendees found matching your search.</p>
                            <p>Try a different search term or clear the search box.</p>
                        </div>
                    `;
                } else if (searchQuery) {
                    // No connections and search was performed
                    connectionsList.innerHTML += `
                        <div class="empty-state">
                            <i class="fas fa-search"></i>
                            <p>No attendees found matching your search.</p>
                            <p>You're currently the only attendee at this conference.</p>
                        </div>
                    `;
                } else {
                    // No connections and no search, fresh empty state
                    connectionsList.innerHTML += `
                        <div class="empty-state">
                            <i class="fas fa-user-friends"></i>
                            <p>You're the only attendee at this conference right now.</p>
                            <p>Invite others to join this conference!</p>
                            <div>
                                <button class="btn" onclick="showShareOptions()" style="margin-top: 15px;">
                                    <i class="fas fa-share-alt"></i> Share Conference Link
                                </button>
                            </div>
                        </div>
                    `;
                }
            } else {
                // Display all filtered connections
                filteredConnections.forEach(connection => {
                    console.log('Displaying connection:', connection);
                    const connectionItem = createConnectionItem(connection);
                    connectionsList.appendChild(connectionItem);
                });
            }
        }
        
        // Function to create connection item element
        function createConnectionItem(connection) {
            const item = document.createElement('div');
            item.className = 'connection-item';
            
            // Create image element with error handling
            const imgElement = document.createElement('img');
            imgElement.src = connection.pictureUrl;
            imgElement.alt = connection.name;
            imgElement.className = 'connection-img';
            
            // Set up error handling for the image
            imgElement.onerror = function() {
                console.log('Profile image failed to load:', this.src);
                this.onerror = null; // Prevent infinite loop
                this.src = 'https://randomuser.me/api/portraits/men/1.jpg';
            };
            
            // Use the profile URL from the connection object
            const profileUrl = connection.profileUrl;
            console.log(`Profile URL for ${connection.name}:`, profileUrl);
            
            // Check if this is the current user
            const currentUserId = JSON.parse(localStorage.getItem('linkedInUser')).id;
            const isCurrentUser = connection.id === currentUserId;
            
            item.innerHTML = `
                <div class="connection-info">
                    <h3>${connection.name} 
                        ${isCurrentUser ? '<span class="status-badge" style="background-color: #e3f2fd; color: #0d47a1;">You</span>' : 
                        '<span class="status-badge">Attending ' + conferenceName + '</span>'}
                    </h3>
                    <p>${connection.title}</p>
                    ${connection.company ? `<p>${connection.company}</p>` : ''}
                    <p class="mutual">Last active ${connection.lastActive} minutes ago</p>
                </div>
                <div class="connection-actions">
                    <button class="btn btn-outline" onclick="viewProfile('${profileUrl}', '${connection.id}')">
                        <i class="fas fa-user"></i> Profile
                    </button>
                </div>
            `;
            
            // Insert the image element at the beginning
            item.insertBefore(imgElement, item.firstChild);
            
            return item;
        }
        
        // Function to refresh connections
        async function refreshConnections() {
            try {
                // Show loading overlay
                document.getElementById('loadingOverlay').style.display = 'flex';
                
                // Clear any cached connections data
                allConnections = [];
                
                // Empty the current connections list to show it's refreshing
                const connectionsList = document.getElementById('connections-list');
                connectionsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-sync-alt fa-spin"></i>
                        <p>Refreshing attendee data...</p>
                        <p>Checking for attendees at this conference.</p>
                    </div>
                `;
                
                // Register for conference to ensure we're registered
                const registerResult = await registerForConference();
                console.log('Registration result during refresh:', registerResult);
                
                // Add a short delay to ensure registration is processed
                await new Promise(resolve => setTimeout(resolve, 800));
                
                // Generate and display connections
                const connections = await generateConnections();
                
                // Request backend debug info
                const debugInfo = await fetchDebugInfo();
                updateDebugPanel(debugInfo);
                
                // If we get data back, display it
                if (connections && connections.length > 0) {
                    console.log(`Refreshed ${connections.length} connections successfully`);
                    displayConnections(connections);
                } else {
                    // Always include at least the current user
                    const userData = JSON.parse(localStorage.getItem('linkedInUser'));
                    const currentUser = {
                        id: userData.id || userData.sub,
                        name: userData.name || `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || 'You',
                        title: userData.headline || userData.title || 'Conference Attendee',
                        company: userData.company || '',
                        pictureUrl: userData.profilePicture || userData.pictureUrl || userData.picture || 'https://randomuser.me/api/portraits/people/1.jpg',
                        profileUrl: 'https://www.linkedin.com/feed/',
                        lastActive: 0
                    };
                    
                    console.log('No attendees from API, but showing current user:', currentUser);
                    displayConnections([currentUser]);
                    
                    // Update UI to show no other attendees found
                    const welcomeMessage = connectionsList.querySelector('.conference-context');
                    if (welcomeMessage) {
                        welcomeMessage.innerHTML = `
                            <h3>Welcome, ${currentUser.name}!</h3>
                            <p>Conference: "${localStorage.getItem('conferenceName')}"</p>
                            <p>You're the only attendee right now. Share this conference to invite others!</p>
                            <button class="btn" onclick="showShareOptions()" style="margin-top: 10px;">
                                <i class="fas fa-share-alt"></i> Share Conference Link
                            </button>
                        `;
                    }
                }
                
                // Hide loading overlay
                document.getElementById('loadingOverlay').style.display = 'none';
                
                // Show success message
                const successIndicator = document.createElement('div');
                successIndicator.className = 'visibility-indicator';
                successIndicator.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background-color: #28a745;
                    color: white;
                    padding: 10px 20px;
                    border-radius: 4px;
                    z-index: 1000;
                    animation: fadeOut 3s forwards;
                `;
                successIndicator.textContent = 'Refreshed successfully';
                document.body.appendChild(successIndicator);
                
                // Remove the indicator after animation
                setTimeout(() => successIndicator.remove(), 3000);
                
            } catch (error) {
                console.error('Error refreshing connections:', error);
                
                // Hide loading overlay
                document.getElementById('loadingOverlay').style.display = 'none';
                
                // Show error message in connections list
                const connectionsList = document.getElementById('connections-list');
                connectionsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i>
                        <p>Error refreshing attendee list: ${error.message}</p>
                        <p>Please try again later.</p>
                        <button class="btn" onclick="refreshConnections()">
                            <i class="fas fa-sync-alt"></i> Try Again
                        </button>
                    </div>
                `;
            }
        }
        
        // Function to fetch debug info from the server
        async function fetchDebugInfo() {
            try {
                const debugUrl = '/.netlify/functions/debug-store?action=get_debug_info';
                const response = await fetch(debugUrl, {
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache, no-store' 
                    }
                });
                
                if (!response.ok) {
                    console.error('Error fetching debug info:', response.status, response.statusText);
                    return null;
                }
                
                const data = await response.json();
                console.log('Debug info:', data);
                return data;
            } catch (error) {
                console.error('Error fetching debug info:', error);
                return null;
            }
        }

        // Function to update the debug panel with info
        function updateDebugPanel(debugInfo) {
            const debugPanel = document.getElementById('debug-info');
            if (!debugPanel) return;
            
            try {
                // Get info about the current user and conference
                const userData = JSON.parse(localStorage.getItem('linkedInUser') || '{}');
                const conferenceId = localStorage.getItem('conferenceId') || 'N/A';
                const conferenceName = localStorage.getItem('conferenceName') || 'N/A';
                const userVisible = localStorage.getItem('userVisibility') !== 'false';
                
                // Build debug info string
                let debugStr = `Conference ID: ${conferenceId}\n`;
                debugStr += `Conference Name: ${conferenceName}\n`;
                debugStr += `Current User: ${userData.name || userData.id || 'Unknown'} (${userData.id || 'No ID'})\n`;
                debugStr += `User Visibility: ${userVisible ? 'Visible' : 'Hidden'}\n\n`;
                
                // Add server info if available
                if (debugInfo && debugInfo.debugInfo) {
                    debugStr += 'Server Data:\n';
                    
                    if (debugInfo.debugInfo[conferenceId]) {
                        const confInfo = debugInfo.debugInfo[conferenceId];
                        debugStr += `- Total Attendees: ${confInfo.totalAttendees}\n`;
                        debugStr += `- Visible Attendees: ${confInfo.visibleAttendees}\n`;
                        
                        if (confInfo.attendeeIds && confInfo.attendeeIds.length > 0) {
                            debugStr += `- Attendee IDs: ${JSON.stringify(confInfo.attendeeIds)}\n`;
                            debugStr += `- Current User is in list: ${confInfo.attendeeIds.includes(userData.id) ? 'Yes' : 'No'}\n`;
                        }
                    } else {
                        debugStr += '- Conference not found on server\n';
                    }
                } else {
                    debugStr += 'Server Data: Unable to fetch\n';
                }
                
                // Update the debug panel
                debugPanel.textContent = debugStr;
            } catch (error) {
                console.error('Error updating debug panel:', error);
                debugPanel.textContent = `Error: ${error.message}`;
            }
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function() {
            const searchValue = this.value.toLowerCase();
            displayConnections(allConnections, searchValue);
        });
        
        // Function to message a connection
        function messageConnection(connectionId) {
            const connection = allConnections.find(c => c.id === connectionId);
            if (connection) {
                alert(`Sending message to ${connection.name}.\n\nIn a real application, this would open a LinkedIn message dialog.`);
            }
        }
        
        // Function to view a profile
        function viewProfile(profileUrl, attendeeId) {
            console.log('Opening profile for attendee ID:', attendeeId);
            console.log('Original profile URL:', profileUrl);
            
            // Get the current user data
            const linkedInProfile = localStorage.getItem('linkedInUser');
            let currentUser = null;
            if (linkedInProfile) {
                try {
                    currentUser = JSON.parse(linkedInProfile);
                } catch (error) {
                    console.error('Error parsing LinkedIn profile:', error);
                }
            }
            
            // If this is the current user's profile, redirect to their LinkedIn feed
            if (currentUser && attendeeId === currentUser.id) {
                console.log('Opening user\'s own profile - redirecting to LinkedIn feed');
                window.open('https://www.linkedin.com/feed/', '_blank');
                return;
            }
            
            // Find the connection in our list to get the full profile data
            const connection = allConnections.find(c => c.id === attendeeId);
            console.log('Connection data for profile button click:', connection);
            
            // If the profileUrl starts with "search:", it means we don't have a valid URL
            // and need to search for the person instead
            if (profileUrl.startsWith('search:')) {
                if (connection && connection.name) {
                    const searchName = encodeURIComponent(connection.name);
                    console.log(`Using LinkedIn search for ${connection.name}`);
                    
                    // For demonstration purposes, open LinkedIn search in a new tab
                    window.open(`https://www.linkedin.com/search/results/people/?keywords=${searchName}`, '_blank');
                } else {
                    // If we can't find the connection details, just go to LinkedIn
                    console.log('No connection details found, redirecting to LinkedIn homepage');
                    window.open('https://www.linkedin.com/', '_blank');
                }
                return;
            }
            
            // Ensure the URL starts with https://
            if (!profileUrl.startsWith('http')) {
                profileUrl = 'https://' + profileUrl.replace(/^\/\//, '');
            }
            
            console.log('Final profile URL:', profileUrl);
            
            // Open the URL in a new tab
            window.open(profileUrl, '_blank');
        }
        
        // Logout function
        function logout() {
            localStorage.removeItem('isAuthenticated');
            localStorage.removeItem('linkedInUser');
            window.location.href = 'auth.html';
        }
        
        // Function to go to auth page
        function goToAuth() {
            // Create a test conference
            const testConferenceId = 'conf_' + Date.now();
            const testConferenceName = 'Conference ' + new Date().toLocaleDateString();
            const testConferenceLocation = 'Virtual';
            
            // Store in sessionStorage
            sessionStorage.setItem('conferenceId', testConferenceId);
            sessionStorage.setItem('conferenceName', testConferenceName);
            sessionStorage.setItem('conferenceLocation', testConferenceLocation);
            
            // Redirect to auth with parameters
            window.location.href = `auth.html?id=${testConferenceId}&name=${encodeURIComponent(testConferenceName)}&location=${encodeURIComponent(testConferenceLocation)}`;
        }
        
        // Function to bypass auth check
        function bypassAuthCheck() {
            window.location.href = window.location.pathname + '?bypass_auth=true';
        }
        
        // Function to test LinkedIn profile format
        function testLinkedInFormat() {
            // Create a test user profile with the LinkedIn API format
            const testProfile = {
                id: "linkedin_test_user_" + Date.now(),
                firstName: {
                    localized: {
                        en_US: "John"
                    },
                    preferredLocale: {
                        country: "US",
                        language: "en"
                    }
                },
                lastName: {
                    localized: {
                        en_US: "Doe"
                    },
                    preferredLocale: {
                        country: "US",
                        language: "en"
                    }
                },
                profilePicture: {
                    displayImage: "https://randomuser.me/api/portraits/men/1.jpg"
                },
                emailAddress: "john.doe@example.com",
                // Conference information
                conference: {
                    id: "conf_linkedin_test",
                    name: "LinkedIn Test Conference",
                    location: "Virtual Event"
                }
            };
            
            // Save to localStorage
            try {
                localStorage.setItem('linkedInUser', JSON.stringify(testProfile));
                localStorage.setItem('conferenceId', testProfile.conference.id);
                localStorage.setItem('conferenceName', testProfile.conference.name);
                localStorage.setItem('conferenceLocation', testProfile.conference.location);
                localStorage.setItem('isAuthenticated', 'true');
                localStorage.setItem('authTime', new Date().toISOString());
                
                // Log the user ID
                console.log(`Created test user with LinkedIn format. User ID: ${testProfile.id}`);
                alert(`LinkedIn format data set in localStorage.\nUser ID: ${testProfile.id}\nRefreshing page...`);
                
                // Register this user for the conference
                setTimeout(() => {
                    registerForConference()
                        .then(() => refreshPage())
                        .catch(err => {
                            console.error('Error registering test user:', err);
                            refreshPage();
                        });
                }, 500);
            } catch (error) {
                alert('Error setting LinkedIn test data: ' + error.message);
            }
        }
        
        // Function to test LinkedIn OAuth response format
        function testLinkedInOAuth() {
            // Create a test user profile with the LinkedIn OAuth format
            // This is the format we get when using Sign In with LinkedIn OAuth 2.0
            const testProfile = {
                sub: "oauth_test_user_" + Date.now(),
                name: "Jane Doe",
                given_name: "Jane",
                family_name: "Doe",
                picture: "https://randomuser.me/api/portraits/women/10.jpg",
                email: "jane.doe@example.com",
                email_verified: true,
                locale: "en_US",
                // LinkedIn specific fields
                at_hash: "abcdefghijklmnop",
                aud: "12345678",
                exp: 1616239022,
                iat: 1616235422,
                iss: "https://www.linkedin.com",
                jti: "abcdefghijklmnopqrstuvwxyz12345",
                nbf: 1616235422,
                nonce: "abcdefghijklmnopqrstuvwxyz12345",
                // Conference information
                conference: {
                    id: "conf_oidc_test",
                    name: "OAuth Test Conference",
                    location: "Virtual Event"
                }
            };
            
            // Save to localStorage
            try {
                localStorage.setItem('linkedInUser', JSON.stringify(testProfile));
                localStorage.setItem('conferenceId', testProfile.conference.id);
                localStorage.setItem('conferenceName', testProfile.conference.name);
                localStorage.setItem('conferenceLocation', testProfile.conference.location);
                localStorage.setItem('isAuthenticated', 'true');
                localStorage.setItem('authTime', new Date().toISOString());
                
                // Log the user ID
                console.log(`Created test user with OAuth format. User ID (sub): ${testProfile.sub}`);
                alert(`LinkedIn OAuth format data set in localStorage.\nUser ID: ${testProfile.sub}\nRefreshing page...`);
                
                // Register this user for the conference
                setTimeout(() => {
                    registerForConference()
                        .then(() => refreshPage())
                        .catch(err => {
                            console.error('Error registering test user:', err);
                            refreshPage();
                        });
                }, 500);
            } catch (error) {
                alert('Error setting OAuth test data: ' + error.message);
            }
        }
        
        // Register user for conference - fixed to work with the API
        async function registerForConference() {
            const userData = JSON.parse(localStorage.getItem('linkedInUser'));
            const userId = userData.id || userData.sub;
            const conferenceId = localStorage.getItem('conferenceId');
            const isVisible = localStorage.getItem('userVisibility') !== 'false';
            
            console.log('Registering user for conference:', {
                userId,
                conferenceId,
                isVisible
            });

            try {
                // Use properly formatted API URL with Netlify redirects
                const registerUrl = '/.netlify/functions/conference-register';
                
                // Build proper user data to register
                // Normalize data from various LinkedIn API formats
                let name = userData.name;
                if (!name && (userData.firstName || userData.lastName)) {
                    name = `${userData.firstName || ''} ${userData.lastName || ''}`.trim();
                }
                if (!name && (userData.given_name || userData.family_name)) {
                    name = `${userData.given_name || ''} ${userData.family_name || ''}`.trim();
                }
                
                // Normalize email
                const email = userData.email || userData.emailAddress || 'email@example.com';
                
                // Normalize profile picture
                let profilePicture = userData.profilePicture || userData.pictureUrl || userData.picture;
                if (typeof profilePicture === 'object' && profilePicture?.['displayImage~']?.elements?.[0]?.identifiers?.[0]?.identifier) {
                    profilePicture = profilePicture['displayImage~'].elements[0].identifiers[0].identifier;
                }
                
                // Create standardized profile data
                const profileData = {
                    userId,
                    conferenceId,
                    isVisible,
                    userData: {
                        id: userId,
                        name: name || 'Conference Attendee',
                        email: email,
                        profilePicture: profilePicture || '',
                        headline: userData.headline || userData.title || '',
                        company: userData.company || userData.currentPosition?.companyName || '',
                        title: userData.title || userData.headline || '',
                        joinedAt: new Date().toISOString()
                    }
                };

                console.log('Sending registration data:', JSON.stringify(profileData));

                // Try both netlify function path and standard API path
                let registered = false;
                let error = null;
                
                // 1. Try Netlify Functions path
                try {
                    const response = await fetch(registerUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'Cache-Control': 'no-cache, no-store'
                        },
                        body: JSON.stringify(profileData)
                    });

                    if (response.ok) {
                        console.log('Successfully registered using Netlify Functions path');
                        registered = true;
                        try {
                            return await response.json();
                        } catch (e) {
                            return { success: true, method: 'netlify' };
                        }
                    } else {
                        const errorText = await response.text();
                        console.error('Netlify registration error:', errorText);
                        error = new Error(`Netlify registration failed: ${response.status} ${response.statusText}`);
                    }
                } catch (netlifyError) {
                    console.error('Error with Netlify registration:', netlifyError);
                    error = netlifyError;
                }
                
                // 2. Try standard API path if Netlify path failed
                if (!registered) {
                    try {
                        const fallbackUrl = '/api/conference/register';
                        console.log('Trying alternative API URL:', fallbackUrl);
                        
                        const fallbackResponse = await fetch(fallbackUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json',
                                'Cache-Control': 'no-cache, no-store'
                            },
                            body: JSON.stringify(profileData)
                        });
                        
                        if (fallbackResponse.ok) {
                            console.log('Successfully registered using standard API path');
                            registered = true;
                            try {
                                return await fallbackResponse.json();
                            } catch (e) {
                                return { success: true, method: 'standard' };
                            }
                        } else {
                            const fallbackErrorText = await fallbackResponse.text();
                            console.error('Standard API registration error:', fallbackErrorText);
                            error = new Error(`Standard API registration failed: ${fallbackResponse.status} ${fallbackResponse.statusText}`);
                        }
                    } catch (standardError) {
                        console.error('Error with standard API registration:', standardError);
                        error = standardError;
                    }
                }
                
                // 3. Try direct debug store as a last resort
                if (!registered) {
                    try {
                        const directUrl = `/.netlify/functions/debug-store?action=set_conference_data&conferenceId=${encodeURIComponent(conferenceId)}&userId=${encodeURIComponent(userId)}&name=${encodeURIComponent(name || 'User')}`;
                        console.log('Trying direct debug store:', directUrl);
                        
                        const directResponse = await fetch(directUrl);
                        if (directResponse.ok) {
                            console.log('Successfully registered using direct debug store');
                            registered = true;
                            return { success: true, method: 'direct' };
                        } else {
                            console.error('Direct debug store registration failed:', await directResponse.text());
                        }
                    } catch (directError) {
                        console.error('Error with direct debug store:', directError);
                    }
                }
                
                if (!registered && error) {
                    throw error;
                }
                
                return { success: true, method: 'unknown' };
            } catch (error) {
                console.error('Error registering for conference:', error);
                throw error;
            }
        }

        // Update visibility function to use backend
        async function updateVisibility(isVisible) {
            const status = document.getElementById('visibility-status');
            const userData = JSON.parse(localStorage.getItem('linkedInUser'));
            const userId = userData.id;
            const conferenceId = localStorage.getItem('conferenceId');
            
            console.log('Updating visibility:', {
                userId,
                conferenceId,
                isVisible
            });
            
            try {
                // First ensure user is registered for the conference
                const registerResult = await registerForConference();
                console.log('Register result before visibility update:', registerResult);
                
                // Then update visibility status
                const visibilityUrl = '/.netlify/functions/conference-visibility';
                console.log('Updating visibility at URL:', visibilityUrl);
                
                // Build complete user data similar to registration
                let name = userData.name;
                if (!name && (userData.firstName || userData.lastName)) {
                    name = `${userData.firstName || ''} ${userData.lastName || ''}`.trim();
                }
                if (!name && (userData.given_name || userData.family_name)) {
                    name = `${userData.given_name || ''} ${userData.family_name || ''}`.trim();
                }
                
                // Normalize email
                const email = userData.email || userData.emailAddress || 'email@example.com';
                
                // Normalize profile picture
                let profilePicture = userData.profilePicture || userData.pictureUrl || userData.picture;
                if (typeof profilePicture === 'object' && profilePicture?.['displayImage~']?.elements?.[0]?.identifiers?.[0]?.identifier) {
                    profilePicture = profilePicture['displayImage~'].elements[0].identifiers[0].identifier;
                }
                
                const visibilityData = {
                    userId,
                    conferenceId,
                    isVisible,
                    userData: {
                        id: userId,
                        name: name || 'Conference Attendee',
                        email: email,
                        profilePicture: profilePicture || '',
                        headline: userData.headline || userData.title || '',
                        company: userData.company || userData.currentPosition?.companyName || '',
                        title: userData.title || userData.headline || ''
                    }
                };
                
                const response = await fetch(visibilityUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache, no-store'
                    },
                    body: JSON.stringify(visibilityData)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Visibility update error:', errorText);
                    throw new Error('Failed to update visibility');
                }

                console.log('Successfully updated visibility');
                
                status.textContent = isVisible ? 'Visible to Other Attendees' : 'Hidden from Other Attendees';
                localStorage.setItem('userVisibility', isVisible.toString());
                
                // Update the visibility indicator without affecting the connections list
                const visibilityIndicator = document.createElement('div');
                visibilityIndicator.className = 'visibility-indicator';
                visibilityIndicator.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background-color: ${isVisible ? '#28a745' : '#dc3545'};
                    color: white;
                    padding: 10px 20px;
                    border-radius: 4px;
                    z-index: 1000;
                    animation: fadeOut 3s forwards;
                `;
                visibilityIndicator.textContent = isVisible ? 'You are visible to other attendees' : 'You are hidden from other attendees';
                document.body.appendChild(visibilityIndicator);
                
                // Remove the indicator after animation
                setTimeout(() => visibilityIndicator.remove(), 3000);
                
                // Refresh connections if we're visible now
                if (isVisible) {
                    setTimeout(refreshConnections, 1000);
                }
            } catch (error) {
                console.error('Error updating visibility:', error);
                alert('Failed to update visibility: ' + error.message);
                // Revert the toggle
                document.getElementById('visibility-toggle').checked = !isVisible;
            }
        }

        // Initialize visibility from stored preference
        function initializeVisibility() {
            // Get stored visibility preference, default to visible if not set
            const storedVisibility = localStorage.getItem('userVisibility');
            const isVisible = storedVisibility === null ? true : storedVisibility !== 'false';
            
            // Update the toggle
            const visibilityToggle = document.getElementById('visibility-toggle');
            visibilityToggle.checked = isVisible;
            
            // Update the status text immediately
            const status = document.getElementById('visibility-status');
            status.textContent = isVisible ? 'Visible to Other Attendees' : 'Hidden from Other Attendees';
            
            // Ensure visibility setting is saved
            localStorage.setItem('userVisibility', isVisible.toString());
            
            // Register for conference and update visibility in the background
            registerForConference().catch(error => {
                console.error('Error during initialization:', error);
            });
        }

        // Add CSS for visibility indicator animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeOut {
                0% { opacity: 1; }
                70% { opacity: 1; }
                100% { opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Display user profile data
        function displayUserProfile() {
            // Get user data from localStorage
            const userData = localStorage.getItem('linkedInUser');
            if (!userData) {
                // Redirect to auth page if no user data is found
                window.location.href = 'auth.html';
                return;
            }
            
            try {
                // Parse user data
                const user = JSON.parse(userData);
                
                // Get conference info from localStorage
                const conferenceId = localStorage.getItem('conferenceId') || 'default_conference';
                const conferenceName = localStorage.getItem('conferenceName') || 'Sample Conference';
                const conferenceLocation = localStorage.getItem('conferenceLocation') || 'Virtual Event';
                
                // Store as global variables
                window.conferenceId = conferenceId;
                window.conferenceName = conferenceName;
                
                // Update conference UI
                document.getElementById('conference-name').textContent = conferenceName;
                document.getElementById('conference-location').textContent = conferenceLocation;
                
                // Update user profile info with appropriate fallbacks
                let profileName = user.name;
                if (!profileName && (user.firstName || user.lastName)) {
                    profileName = `${user.firstName || ''} ${user.lastName || ''}`.trim();
                }
                if (!profileName) {
                    profileName = user.id || 'User';
                }
                
                const profileEmail = user.email || 'Email not available';
                
                // Get headline with fallbacks but without using "LinkedIn User" placeholder
                let profileHeadline = '';
                if (user.headline && user.headline !== 'LinkedIn User') {
                    profileHeadline = user.headline;
                } else if (user.currentPosition?.title) {
                    profileHeadline = user.currentPosition.title;
                    if (user.currentPosition.companyName) {
                        profileHeadline += ` at ${user.currentPosition.companyName}`;
                    }
                } else if (user.title) {
                    profileHeadline = user.title;
                } else if (user.company) {
                    profileHeadline = `Professional at ${user.company}`;
                } else {
                    // Leave blank rather than using 'LinkedIn User'
                    profileHeadline = '';
                }
                
                // For the profile picture, try multiple possible paths
                let profilePicture = user.profilePicture;
                if (!profilePicture && user.pictureUrl) {
                    profilePicture = user.pictureUrl;
                }
                if (!profilePicture && user.profilePicture?.['displayImage~']?.elements?.[0]?.identifiers?.[0]?.identifier) {
                    profilePicture = user.profilePicture['displayImage~'].elements[0].identifiers[0].identifier;
                }
                if (!profilePicture) {
                    profilePicture = 'https://randomuser.me/api/portraits/lego/1.jpg';
                }
                
                // Display user profile on the page
                updateProfileUI(profileName, profileEmail, profileHeadline, profilePicture);
                
                // Debug: Display storage information
                displayStorageDebugInfo();
                
            } catch (error) {
                console.error('Error parsing user profile:', error);
                
                // Create fallback values
                const fallbackName = 'Guest User';
                const fallbackEmail = 'guest@example.com';
                const fallbackHeadline = '';
                const fallbackPicture = 'https://randomuser.me/api/portraits/lego/1.jpg';
                
                // Display fallback user profile
                updateProfileUI(fallbackName, fallbackEmail, fallbackHeadline, fallbackPicture);
            }
        }

        // Display debug information in the debug panel
        function displayStorageDebugInfo() {
            const debugElement = document.getElementById('debug-info');
            if (!debugElement) return;
            
            try {
                const userData = JSON.parse(localStorage.getItem('linkedInUser') || '{}');
                const conferenceId = localStorage.getItem('conferenceId') || 'N/A';
                const conferenceName = localStorage.getItem('conferenceName') || 'N/A';
                const userVisible = localStorage.getItem('userVisibility') !== 'false';
                
                // Sanitize user data for display
                const sanitizedUser = { ...userData };
                if (sanitizedUser.profilePicture && sanitizedUser.profilePicture.length > 30) {
                    sanitizedUser.profilePicture = sanitizedUser.profilePicture.substring(0, 30) + '...';
                }
                
                const debugInfo = `
LinkedInUser: ${JSON.stringify(sanitizedUser, null, 2)}
ConferenceId: ${conferenceId}
ConferenceName: ${conferenceName}
UserVisibility: ${userVisible ? 'Visible' : 'Hidden'}
Last Updated: ${new Date().toLocaleTimeString()}
                `;
                
                debugElement.textContent = debugInfo;
            } catch (error) {
                console.error('Error updating debug info:', error);
                debugElement.textContent = 'Error loading debug information';
            }
        }

        // Function to refresh page
        function refreshPage() {
            window.location.reload();
        }

        // Function to clear all data
        function clearAllData() {
            localStorage.clear();
            sessionStorage.clear();
            alert('All local data cleared. The page will now reload.');
            setTimeout(refreshPage, 500);
        }

        // Function to fix test data
        function fixTestData() {
            // Create a valid user profile
            const testUser = {
                id: `test_user_${Date.now()}`,
                firstName: 'Test',
                lastName: 'User',
                name: 'Test User',
                email: 'test@example.com',
                profilePicture: 'https://randomuser.me/api/portraits/people/1.jpg',
                headline: 'Software Developer'
            };
            
            // Store the test data
            localStorage.setItem('linkedInUser', JSON.stringify(testUser));
            localStorage.setItem('isAuthenticated', 'true');
            localStorage.setItem('authTime', new Date().toISOString());
            
            // Set conference data if not already present
            if (!localStorage.getItem('conferenceId')) {
                localStorage.setItem('conferenceId', 'conf_test');
                localStorage.setItem('conferenceName', 'Test Conference');
                localStorage.setItem('conferenceLocation', 'Test Location');
            }
            
            alert('Test data has been set. Refreshing page...');
            setTimeout(refreshPage, 500);
        }

        // Display user profile UI
        function updateProfileUI(profileName, profileEmail, profileHeadline, profileImageUrl) {
            document.getElementById('profile-name').textContent = profileName;
            document.getElementById('profile-email').textContent = profileEmail;
            document.getElementById('profile-headline').textContent = profileHeadline;
            
            // Set profile image with error handling
            const profileImg = document.getElementById('profile-image');
            if (profileImg) {
                profileImg.onerror = function() { 
                    console.warn('Profile image failed to load:', this.src);
                    this.src = 'https://randomuser.me/api/portraits/lego/1.jpg'; 
                };
                profileImg.src = profileImageUrl;
            }
        }

        // Function to share the conference link
        function showShareOptions() {
            const conferenceId = localStorage.getItem('conferenceId');
            const conferenceName = localStorage.getItem('conferenceName');
            
            // Create URL for sharing
            const shareUrl = `${window.location.origin}${window.location.pathname}?id=${conferenceId}&name=${encodeURIComponent(conferenceName)}`;
            
            // Create and show sharing dialog
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.2);
                z-index: 1000;
                width: 90%;
                max-width: 400px;
            `;
            
            dialog.innerHTML = `
                <h3 style="margin-top: 0;">Share Conference Link</h3>
                <p>Share this link to invite others to join this conference:</p>
                <div style="display: flex; margin-bottom: 15px;">
                    <input type="text" value="${shareUrl}" 
                        style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" readonly id="shareUrlInput">
                    <button onclick="copyShareUrl()" style="margin-left: 10px; background: #0077b5; color: white; border: none; border-radius: 4px; padding: 0 15px; cursor: pointer;">
                        Copy
                    </button>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button onclick="closeShareDialog()"
                        style="padding: 8px 15px; background: #f5f5f5; border: none; border-radius: 4px; cursor: pointer;">
                        Close
                    </button>
                </div>
            `;
            
            // Add the dialog to the body
            document.body.appendChild(dialog);
            
            // Store the dialog element for later reference
            window.currentShareDialog = dialog;
            
            // Select the URL for easier copying
            setTimeout(() => {
                document.getElementById('shareUrlInput').select();
            }, 100);
        }

        // Function to copy the share URL to clipboard
        function copyShareUrl() {
            const input = document.getElementById('shareUrlInput');
            input.select();
            document.execCommand('copy');
            
            // Show copied indicator
            const copyBtn = input.nextElementSibling;
            const originalText = copyBtn.textContent;
            copyBtn.textContent = 'Copied!';
            
            setTimeout(() => {
                copyBtn.textContent = originalText;
            }, 2000);
        }

        // Function to close the share dialog
        function closeShareDialog() {
            if (window.currentShareDialog) {
                document.body.removeChild(window.currentShareDialog);
                window.currentShareDialog = null;
            }
        }

        // Function to add a test user directly
        async function directSetTestData() {
            try {
                const conferenceId = localStorage.getItem('conferenceId');
                const currentUser = JSON.parse(localStorage.getItem('linkedInUser'));
                
                // Make sure we have the current user ID
                const currentUserId = currentUser.id || currentUser.sub;
                if (!currentUserId) {
                    alert('Cannot determine current user ID. Please log in again.');
                    return;
                }
                
                // Create a test user with a different ID
                const testUserId = `test_user_${Date.now()}`;
                const testName = `Test User ${new Date().toLocaleTimeString()}`;
                
                // Display info to user
                alert(`Creating test user with ID ${testUserId} and adding to conference ${conferenceId}.\nYour ID is ${currentUserId}`);
                
                // Make a direct request to set the data
                const url = `/.netlify/functions/debug-store?action=set_conference_data&conferenceId=${encodeURIComponent(conferenceId)}&userId=${encodeURIComponent(testUserId)}&name=${encodeURIComponent(testName)}`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('Set test data result:', result);
                
                // Also add the current user to ensure they're visible too
                const currentUserName = currentUser.name || `${currentUser.firstName || ''} ${currentUser.lastName || ''}`.trim() || 'Current User';
                const currentUserUrl = `/.netlify/functions/debug-store?action=set_conference_data&conferenceId=${encodeURIComponent(conferenceId)}&userId=${encodeURIComponent(currentUserId)}&name=${encodeURIComponent(currentUserName)}`;
                
                const currentUserResponse = await fetch(currentUserUrl);
                if (!currentUserResponse.ok) {
                    throw new Error(`Server returned ${currentUserResponse.status}: ${currentUserResponse.statusText} when adding current user`);
                }
                
                const currentUserResult = await currentUserResponse.json();
                console.log('Set current user result:', currentUserResult);
                
                // Wait a moment for data to be saved
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Refresh connections to show the new test user
                refreshConnections();
                
            } catch (error) {
                console.error('Error setting test data:', error);
                alert('Failed to add test user: ' + error.message);
            }
        }

        // Add a function to cleanup test users
        async function cleanupTestUsers() {
            try {
                const conferenceId = localStorage.getItem('conferenceId');
                
                document.getElementById('loadingOverlay').style.display = 'flex';
                
                // Make a direct request to clean up test users
                const url = `/.netlify/functions/debug-store?action=cleanup_test_users&conferenceId=${encodeURIComponent(conferenceId)}`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('Cleanup result:', result);
                
                // Success message
                alert(`Cleaned up ${result.removed || 0} test users. Refreshing data...`);
                
                // Re-register current user
                await registerForConference();
                
                // Wait and refresh
                setTimeout(refreshConnections, 1000);
                
            } catch (error) {
                console.error('Error cleaning up test users:', error);
                alert('Failed to clean up test users: ' + error.message);
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        // Start initialization when the page loads
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>
