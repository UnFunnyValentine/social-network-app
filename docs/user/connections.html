<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conference Connections</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background-color: #0077b5;
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: 8px 8px 0 0;
        }
        .header h1 {
            margin: 0;
            font-size: 20px;
        }
        .conference-info {
            background-color: white;
            border-radius: 0 0 8px 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .user-profile {
            display: flex;
            align-items: center;
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .profile-image {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 20px;
        }
        .profile-info h2 {
            margin: 0 0 5px 0;
            font-size: 18px;
        }
        .profile-info p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
        .section-title {
            margin: 30px 0 15px 0;
            font-size: 18px;
            color: #0077b5;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .section-title .refresh-btn {
            background-color: transparent;
            color: #0077b5;
            border: 1px solid #0077b5;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 14px;
            cursor: pointer;
        }
        .section-title .refresh-btn:hover {
            background-color: rgba(0, 119, 181, 0.1);
        }
        .connections-list {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .connection-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }
        .connection-item:last-child {
            border-bottom: none;
        }
        .connection-img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
        }
        .connection-info {
            flex: 1;
        }
        .connection-info h3 {
            margin: 0 0 5px 0;
            font-size: 16px;
        }
        .connection-info p {
            margin: 0;
            color: #666;
            font-size: 13px;
        }
        .connection-info .mutual {
            margin-top: 5px;
            font-size: 12px;
            color: #0077b5;
        }
        .connection-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }
        .btn {
            background-color: #0077b5;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            transition: background-color 0.3s;
        }
        .btn i {
            margin-right: 5px;
        }
        .btn:hover {
            background-color: #006097;
        }
        .btn-outline {
            background-color: transparent;
            color: #0077b5;
            border: 1px solid #0077b5;
        }
        .btn-outline:hover {
            background-color: rgba(0, 119, 181, 0.1);
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        .empty-state i {
            font-size: 50px;
            color: #ccc;
            margin-bottom: 15px;
        }
        .logout-btn {
            background-color: transparent;
            color: white;
            border: 1px solid white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .search-container {
            margin-bottom: 15px;
        }
        .search-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Montserrat', sans-serif;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 119, 181, 0.2);
            border-radius: 50%;
            border-top-color: #0077b5;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .conference-context {
            padding: 15px;
            background-color: #f0f7ff;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .conference-context h3 {
            margin: 0 0 10px 0;
            color: #0077b5;
        }
        .conference-context p {
            margin: 0;
            color: #555;
        }
        .search-results-info {
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .search-results-info p {
            margin: 0;
            font-style: italic;
            color: #666;
        }
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            .connection-actions {
                flex-direction: column;
                gap: 5px;
            }
        }
        /* Visibility Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin-right: 10px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
        }

        input:checked + .slider {
            background-color: #0077b5;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        .visibility-settings {
            display: flex;
            align-items: center;
            padding: 5px 0;
        }
        @keyframes fadeOut {
            0% { opacity: 1; }
            70% { opacity: 1; }
            100% { opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="container">
        <div class="header">
            <h1><i class="fab fa-linkedin"></i> LinkedIn Conference Connections</h1>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
        
        <!-- Debug panel to show actual storage data -->
        <div style="background-color: #f8f8f8; border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
            <h3 style="margin-top: 0; color: #333;">Storage Debug Info</h3>
            <div id="debug-info" style="font-family: monospace; font-size: 12px; white-space: pre-wrap;"></div>
            <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="refreshPage()" style="padding: 5px 10px; background: #0077b5; color: white; border: none; border-radius: 4px;">Refresh Page</button>
                <button onclick="fixTestData()" style="padding: 5px 10px; background: #28a745; color: white; border: none; border-radius: 4px;">Fix with Test Data</button>
                <button onclick="testLinkedInFormat()" style="padding: 5px 10px; background: #6f42c1; color: white; border: none; border-radius: 4px;">Test LinkedIn API Format</button>
                <button onclick="testLinkedInOAuth()" style="padding: 5px 10px; background: #fd7e14; color: white; border: none; border-radius: 4px;">Test LinkedIn OAuth</button>
                <button onclick="clearAllData()" style="padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px;">Clear All Data</button>
                <button onclick="goToAuth()" style="padding: 5px 10px; background: #f0ad4e; color: white; border: none; border-radius: 4px;">Go to Auth Page</button>
                <button onclick="bypassAuthCheck()" style="padding: 5px 10px; background: #5bc0de; color: white; border: none; border-radius: 4px;">Bypass Auth Check</button>
            </div>
        </div>
        
        <div class="conference-info">
            <h2 id="conference-name">Loading conference info...</h2>
            <p id="conference-location"></p>
            <p><small>Showing LinkedIn connections attending this conference</small></p>
        </div>
        
        <div class="user-profile">
            <img id="profile-image" class="profile-image" src="https://randomuser.me/api/portraits/men/1.jpg" alt="Profile Image">
            <div class="profile-info">
                <h2 id="profile-name">Loading profile...</h2>
                <p id="profile-email"></p>
                <p id="profile-headline" style="margin-top: 5px;"></p>
                <div class="visibility-settings" style="margin-top: 10px;">
                    <label class="switch">
                        <input type="checkbox" id="visibility-toggle" onchange="updateVisibility(this.checked)">
                        <span class="slider round"></span>
                    </label>
                    <span id="visibility-status">Visible to Other Attendees</span>
                </div>
            </div>
        </div>
        
        <div class="search-container">
            <input type="text" class="search-input" placeholder="Search connections..." id="searchInput">
        </div>
        
        <h2 class="section-title">
            Your Connections at this Conference
            <button class="refresh-btn" onclick="refreshConnections()"><i class="fas fa-sync-alt"></i> Refresh</button>
        </h2>
        
        <div class="connections-list" id="connections-list">
            <!-- Will be populated dynamically -->
            <div class="empty-state">
                <i class="fas fa-users"></i>
                <p>Fetching your LinkedIn connections at this conference...</p>
                <p>This may take a few moments.</p>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const apiConfig = {
            baseUrl: 'https://cholebhature.netlify.app/api',
            endpoints: {
                // LinkedIn endpoints
                profile: '/linkedin/profile',
                connections: '/linkedin/connections',
                picture: '/linkedin/picture',
                
                // Conference endpoints
                conferenceAttendees: '/conference',
                conferenceRegister: '/conference/register',
                conferenceVisibility: '/conference/visibility',
                conferenceRecommendations: '/conference/recommendations'
            }
        };

        // Function to get full API URL
        function getApiUrl(endpoint, params = {}) {
            // Ensure the endpoint starts with a slash
            if (!endpoint.startsWith('/')) {
                endpoint = '/' + endpoint;
            }
            
            let url = `${apiConfig.baseUrl}${endpoint}`;
            
            // Add parameters if provided
            if (Object.keys(params).length > 0) {
                const queryParams = new URLSearchParams();
                for (const [key, value] of Object.entries(params)) {
                    queryParams.append(key, value);
                }
                const queryString = queryParams.toString();
                url = queryString ? `${url}?${queryString}` : url;
            }
            
            console.log('Generated API URL:', url);
            return url;
        }

        // Function to generate connections from LinkedIn API
        async function generateConnections() {
            const conferenceId = localStorage.getItem('conferenceId');
            const currentUserId = JSON.parse(localStorage.getItem('linkedInUser')).id;
            
            console.log('Generating connections for:', {
                conferenceId,
                currentUserId
            });
            
            try {
                // First, ensure user is registered for the conference
                console.log('Registering for conference...');
                await registerForConference();
                
                // Set the correct API URL based on production or development
                const baseApiUrl = 'https://cholebhature.netlify.app/api';
                const attendeesEndpoint = `/conference/${conferenceId}/attendees`;
                const attendeesUrl = `${baseApiUrl}${attendeesEndpoint}?currentUserId=${currentUserId}`;
                
                console.log('Fetching conference attendees from:', attendeesUrl);
                
                // Show loading overlay while fetching
                document.getElementById('loadingOverlay').style.display = 'flex';
                
                // Make the API call with proper error handling
                const attendeesResponse = await fetch(attendeesUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    // Include credentials if needed for authentication
                    credentials: 'include'
                });
                
                if (!attendeesResponse.ok) {
                    throw new Error(`Failed to fetch conference attendees: ${attendeesResponse.status} ${attendeesResponse.statusText}`);
                }

                const attendeesData = await attendeesResponse.json();
                console.log('Conference attendees data:', JSON.stringify(attendeesData, null, 2));
                
                const attendees = attendeesData.attendees || [];
                
                if (attendees.length === 0) {
                    console.log('No attendees found, using API to get recommendations');
                    // If no attendees found, try to get recommendations from API
                    const recommendationsEndpoint = `/conference/${conferenceId}/recommendations`;
                    const recommendationsUrl = `${baseApiUrl}${recommendationsEndpoint}?userId=${currentUserId}`;
                    
                    const recommendationsResponse = await fetch(recommendationsUrl);
                    if (recommendationsResponse.ok) {
                        const recommendationsData = await recommendationsResponse.json();
                        if (recommendationsData.recommendations && recommendationsData.recommendations.length > 0) {
                            console.log('Using recommended connections from API');
                            return processAttendees(recommendationsData.recommendations);
                        }
                    }
                    
                    // Try fallback to LinkedIn connections endpoint if available
                    const connectionsEndpoint = `/linkedin/connections`;
                    const connectionsUrl = `${baseApiUrl}${connectionsEndpoint}?userId=${currentUserId}`;
                    
                    const connectionsResponse = await fetch(connectionsUrl);
                    if (connectionsResponse.ok) {
                        const connectionsData = await connectionsResponse.json();
                        if (connectionsData.connections && connectionsData.connections.length > 0) {
                            console.log('Using LinkedIn connections from API');
                            return processAttendees(connectionsData.connections);
                        }
                    }
                    
                    // If still no connections, create a minimal set of attendees
                    console.warn('No attendees found from any source, generating minimal test data');
                    const minimalAttendees = generateMinimalAttendees(5);
                    return processAttendees(minimalAttendees);
                }
                
                // If we have attendees, process them
                return processAttendees(attendees);
                
            } catch (error) {
                console.error('Error generating connections:', error);
                
                // Only if we failed to fetch real data, generate minimal test data
                console.warn('Falling back to minimal test data due to error');
                const minimalAttendees = generateMinimalAttendees(5);
                return processAttendees(minimalAttendees);
            } finally {
                // Hide loading overlay
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        // Helper function to process attendees data into connection format
        function processAttendees(attendees) {
            return attendees.map(attendee => {
                console.log('Processing attendee:', JSON.stringify(attendee, null, 2));
                const profile = attendee.profile || attendee;
                
                let profileUrl;
                if (profile.vanityName && !profile.vanityName.match(/^[A-Z0-9]{8,12}$/i)) {
                    profileUrl = `https://www.linkedin.com/in/${profile.vanityName}`;
                } else if (profile.publicProfileUrl && profile.publicProfileUrl.includes('/in/')) {
                    profileUrl = profile.publicProfileUrl;
                } else {
                    profileUrl = `search:${attendee.id || profile.id}`;
                }
                
                return {
                    id: attendee.id || profile.id,
                    name: profile.name || `${profile.firstName || ''} ${profile.lastName || ''}`.trim() || 'LinkedIn User',
                    title: profile.headline || profile.currentPosition?.title || 'Professional',
                    company: profile.currentPosition?.companyName || profile.company || '',
                    pictureUrl: profile.profilePicture || profile.pictureUrl || 'https://randomuser.me/api/portraits/people/' + Math.floor(Math.random() * 100) + '.jpg',
                    profileUrl: profileUrl,
                    lastActive: Math.floor(Math.random() * 60) + 1,
                    profile: profile
                };
            });
        }

        // Helper function to generate minimal test data only if API fetch fails
        function generateMinimalAttendees(count) {
            // This should only be used as a last resort if real data can't be fetched
            console.warn('Generating minimal test attendees as fallback');
            
            const attendees = [];
            for (let i = 0; i < count; i++) {
                const id = `test_${Date.now()}_${i}`;
                attendees.push({
                    id: id,
                    profile: {
                        id: id,
                        firstName: `Test ${i+1}`,
                        lastName: 'Attendee',
                        headline: 'LinkedIn User',
                        profilePicture: `https://randomuser.me/api/portraits/people/${i * 10 + 5}.jpg`,
                        currentPosition: {
                            title: 'Professional',
                            companyName: 'Company ' + (i+1)
                        }
                    }
                });
            }
            return attendees;
        }

        // Function to display connections
        function displayConnections(connections, searchQuery = '') {
            console.log('Displaying connections:', {
                totalConnections: connections.length,
                searchQuery
            });
            
            // Store in global variable for use with search and other functions
            allConnections = connections;
            
            const connectionsList = document.getElementById('connections-list');
            
            // Clear existing connections
            connectionsList.innerHTML = '';
            
            // Add welcome message and conference context
            const welcomeMessage = document.createElement('div');
            welcomeMessage.className = 'conference-context';
            welcomeMessage.innerHTML = `
                <h3>Welcome, ${document.getElementById('profile-name').textContent}!</h3>
                <p>Find your connections attending "${conferenceName}" below.</p>
                <p>Total attendees: ${connections.length}</p>
            `;
            connectionsList.appendChild(welcomeMessage);
            
            // Filter connections based on search query if provided
            let filteredConnections = connections;
            if (searchQuery && searchQuery.trim() !== '') {
                const query = searchQuery.toLowerCase();
                filteredConnections = connections.filter(conn => 
                    conn.name.toLowerCase().includes(query) || 
                    conn.title.toLowerCase().includes(query) ||
                    conn.company.toLowerCase().includes(query)
                );
                
                // Add search results heading
                const searchHeading = document.createElement('div');
                searchHeading.className = 'search-results-info';
                searchHeading.innerHTML = `<p>Found ${filteredConnections.length} matching attendee(s) for "${searchQuery}"</p>`;
                connectionsList.appendChild(searchHeading);
            }
            
            if (filteredConnections.length === 0) {
                connectionsList.innerHTML += `
                    <div class="empty-state">
                        <i class="fas fa-user-slash"></i>
                        <p>No attendees found${searchQuery ? ' matching your search' : ''}.</p>
                        <p>${searchQuery ? 'Try a different search term' : 'Try refreshing the connections'}.</p>
                    </div>
                `;
            } else {
                // Display all filtered connections
                filteredConnections.forEach(connection => {
                    console.log('Displaying connection:', connection);
                    const connectionItem = createConnectionItem(connection);
                    connectionsList.appendChild(connectionItem);
                });
            }
        }
        
        // Function to create connection item element
        function createConnectionItem(connection) {
            const item = document.createElement('div');
            item.className = 'connection-item';
            
            // Create image element with error handling
            const imgElement = document.createElement('img');
            imgElement.src = connection.pictureUrl;
            imgElement.alt = connection.name;
            imgElement.className = 'connection-img';
            
            // Set up error handling for the image
            imgElement.onerror = function() {
                console.log('Profile image failed to load:', this.src);
                this.onerror = null; // Prevent infinite loop
                this.src = 'https://randomuser.me/api/portraits/men/1.jpg';
            };
            
            // Use the profile URL from the connection object
            const profileUrl = connection.profileUrl;
            console.log(`Profile URL for ${connection.name}:`, profileUrl);
            
            item.innerHTML = `
                <div class="connection-info">
                    <h3>${connection.name} <span class="status-badge">Attending ${conferenceName}</span></h3>
                    <p>${connection.title}</p>
                    ${connection.company ? `<p>${connection.company}</p>` : ''}
                    <p class="mutual">Last active ${connection.lastActive} minutes ago</p>
                </div>
                <div class="connection-actions">
                    <button class="btn btn-outline" onclick="viewProfile('${profileUrl}', '${connection.id}')">
                        <i class="fas fa-user"></i> Profile
                    </button>
                </div>
            `;
            
            // Insert the image element at the beginning
            item.insertBefore(imgElement, item.firstChild);
            
            return item;
        }
        
        // Initialize the page
        async function initializePage() {
            try {
                // Display user profile first
                displayUserProfile();
                
                // Hide loading overlay immediately
                document.getElementById('loadingOverlay').style.display = 'none';
                
                // Generate and display connections
                const connections = await generateConnections();
                displayConnections(connections);
                
                // Initialize visibility
                initializeVisibility();
            } catch (error) {
                console.error('Error initializing page:', error);
                document.getElementById('loadingOverlay').style.display = 'none';
                alert('Error loading connections. Please try refreshing the page.');
            }
        }

        // Start initialization when the page loads
        document.addEventListener('DOMContentLoaded', initializePage);
        
        // Handle refreshing connections
        async function refreshConnections() {
            try {
                // Show loading overlay
                document.getElementById('loadingOverlay').style.display = 'flex';
                
                // Clear any cached connections data
                allConnections = [];
                
                // Empty the current connections list to show it's refreshing
                const connectionsList = document.getElementById('connections-list');
                connectionsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-sync-alt fa-spin"></i>
                        <p>Refreshing LinkedIn connections data...</p>
                        <p>Fetching attendees for this conference from LinkedIn.</p>
                    </div>
                `;
                
                // Generate and display connections with force refresh
                const connections = await generateConnections();
                
                // If we get data back, display it
                if (connections && connections.length > 0) {
                    console.log(`Refreshed ${connections.length} connections successfully`);
                    displayConnections(connections);
                } else {
                    // If we didn't get any data, show empty state
                    console.warn('No connections returned after refresh');
                    connectionsList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-user-slash"></i>
                            <p>No LinkedIn connections found at this conference.</p>
                            <p>Try again later or check your LinkedIn connection settings.</p>
                        </div>
                    `;
                }
                
                // Hide loading overlay
                document.getElementById('loadingOverlay').style.display = 'none';
                
                // Show success message
                const successIndicator = document.createElement('div');
                successIndicator.className = 'visibility-indicator';
                successIndicator.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background-color: #28a745;
                    color: white;
                    padding: 10px 20px;
                    border-radius: 4px;
                    z-index: 1000;
                    animation: fadeOut 3s forwards;
                `;
                successIndicator.textContent = 'Connections refreshed successfully';
                document.body.appendChild(successIndicator);
                
                // Remove the indicator after animation
                setTimeout(() => successIndicator.remove(), 3000);
                
            } catch (error) {
                console.error('Error refreshing connections:', error);
                
                // Hide loading overlay
                document.getElementById('loadingOverlay').style.display = 'none';
                
                // Show error message
                alert('Error refreshing connections: ' + error.message);
            }
        }
        
        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function() {
            const searchValue = this.value.toLowerCase();
            displayConnections(allConnections, searchValue);
        });
        
        // Function to message a connection
        function messageConnection(connectionId) {
            const connection = allConnections.find(c => c.id === connectionId);
            if (connection) {
                alert(`Sending message to ${connection.name}.\n\nIn a real application, this would open a LinkedIn message dialog.`);
            }
        }
        
        // Function to view a profile
        function viewProfile(profileUrl, attendeeId) {
            console.log('Opening profile for attendee ID:', attendeeId);
            console.log('Original profile URL:', profileUrl);
            
            // Get the current user data
            const linkedInProfile = localStorage.getItem('linkedInUser');
            let currentUser = null;
            if (linkedInProfile) {
                try {
                    currentUser = JSON.parse(linkedInProfile);
                } catch (error) {
                    console.error('Error parsing LinkedIn profile:', error);
                }
            }
            
            // If this is the current user's profile, redirect to their LinkedIn feed
            if (currentUser && attendeeId === currentUser.id) {
                console.log('Opening user\'s own profile - redirecting to LinkedIn feed');
                window.open('https://www.linkedin.com/feed/', '_blank');
                return;
            }
            
            // Find the connection in our list to get the full profile data
            const connection = allConnections.find(c => c.id === attendeeId);
            console.log('Connection data for profile button click:', connection);
            
            // If the profileUrl starts with "search:", it means we don't have a valid URL
            // and need to search for the person instead
            if (profileUrl.startsWith('search:')) {
                if (connection && connection.name) {
                    const searchName = encodeURIComponent(connection.name);
                    console.log(`Using LinkedIn search for ${connection.name}`);
                    
                    // For demonstration purposes, open LinkedIn search in a new tab
                    window.open(`https://www.linkedin.com/search/results/people/?keywords=${searchName}`, '_blank');
                } else {
                    // If we can't find the connection details, just go to LinkedIn
                    console.log('No connection details found, redirecting to LinkedIn homepage');
                    window.open('https://www.linkedin.com/', '_blank');
                }
                return;
            }
            
            // Ensure the URL starts with https://
            if (!profileUrl.startsWith('http')) {
                profileUrl = 'https://' + profileUrl.replace(/^\/\//, '');
            }
            
            console.log('Final profile URL:', profileUrl);
            
            // Open the URL in a new tab
            window.open(profileUrl, '_blank');
        }
        
        // Logout function
        function logout() {
            localStorage.removeItem('isAuthenticated');
            localStorage.removeItem('linkedInUser');
            window.location.href = 'auth.html';
        }
        
        // Function to go to auth page
        function goToAuth() {
            // Create a test conference
            const testConferenceId = 'conf_' + Date.now();
            const testConferenceName = 'Conference ' + new Date().toLocaleDateString();
            const testConferenceLocation = 'Virtual';
            
            // Store in sessionStorage
            sessionStorage.setItem('conferenceId', testConferenceId);
            sessionStorage.setItem('conferenceName', testConferenceName);
            sessionStorage.setItem('conferenceLocation', testConferenceLocation);
            
            // Redirect to auth with parameters
            window.location.href = `auth.html?id=${testConferenceId}&name=${encodeURIComponent(testConferenceName)}&location=${encodeURIComponent(testConferenceLocation)}`;
        }
        
        // Function to bypass auth check
        function bypassAuthCheck() {
            window.location.href = window.location.pathname + '?bypass_auth=true';
        }
        
        // Function to test different LinkedIn profile formats
        function testLinkedInFormat() {
            // Create a test user profile with the exact LinkedIn API format
            const testProfile = {
                id: 'linkedin_test_user',
                // LinkedIn R_EMAILADDRESS scope
                emailAddress: 'test.user@example.com',
                firstName: {
                    localized: {
                        en_US: 'Test'
                    },
                    preferredLocale: {
                        country: 'US',
                        language: 'en'
                    }
                },
                lastName: {
                    localized: {
                        en_US: 'User'
                    },
                    preferredLocale: {
                        country: 'US',
                        language: 'en'
                    }
                },
                // LinkedIn API v2 format for profile picture
                profilePicture: {
                    'displayImage~': {
                        elements: [
                            {
                                identifiers: [
                                    {
                                        identifier: 'https://randomuser.me/api/portraits/men/1.jpg'
                                    }
                                ]
                            }
                        ]
                    }
                },
                // Basic profile info
                headline: 'Software Engineer at LinkedIn',
                vanityName: 'testuser',
                // Current conference info
                currentConference: {
                    id: 'conf_linkedin_test',
                    name: 'LinkedIn Developer Conference',
                    location: 'LinkedIn HQ, Sunnyvale, CA'
                }
            };
            
            // Save to localStorage
            try {
                localStorage.setItem('linkedInUser', JSON.stringify(testProfile));
                localStorage.setItem('conferenceId', testProfile.currentConference.id);
                localStorage.setItem('conferenceName', testProfile.currentConference.name);
                localStorage.setItem('conferenceLocation', testProfile.currentConference.location);
                localStorage.setItem('isAuthenticated', 'true');
                localStorage.setItem('authTime', new Date().toISOString());
                
                alert('LinkedIn API format data set in localStorage. Refreshing page...');
                setTimeout(refreshPage, 500);
            } catch (error) {
                alert('Error setting test data: ' + error.message);
            }
        }
        
        // Function to test LinkedIn OAuth response format
        function testLinkedInOAuth() {
            // Create a test user profile with the LinkedIn OAuth format
            // This is the format we get when using Sign In with LinkedIn OAuth 2.0
            const testProfile = {
                sub: "1234567890",
                name: "Jane Doe",
                given_name: "Jane",
                family_name: "Doe",
                picture: "https://randomuser.me/api/portraits/women/10.jpg",
                email: "jane.doe@example.com",
                email_verified: true,
                locale: "en_US",
                // LinkedIn specific fields
                at_hash: "abcdefghijklmnop",
                aud: "12345678",
                exp: 1616239022,
                iat: 1616235422,
                iss: "https://www.linkedin.com",
                jti: "abcdefghijklmnopqrstuvwxyz12345",
                nbf: 1616235422,
                nonce: "abcdefghijklmnopqrstuvwxyz12345",
                // Conference information
                conference: {
                    id: "conf_oidc_test",
                    name: "OAuth Test Conference",
                    location: "Virtual Event"
                }
            };
            
            // Save to localStorage
            try {
                localStorage.setItem('linkedInUser', JSON.stringify(testProfile));
                localStorage.setItem('conferenceId', testProfile.conference.id);
                localStorage.setItem('conferenceName', testProfile.conference.name);
                localStorage.setItem('conferenceLocation', testProfile.conference.location);
                localStorage.setItem('isAuthenticated', 'true');
                localStorage.setItem('authTime', new Date().toISOString());
                
                alert('LinkedIn OAuth format data set in localStorage. Refreshing page...');
                setTimeout(refreshPage, 500);
            } catch (error) {
                alert('Error setting OAuth test data: ' + error.message);
            }
        }
        
        // Register user for conference - fixed to work with the API
        async function registerForConference() {
            const userData = JSON.parse(localStorage.getItem('linkedInUser'));
            const userId = userData.id;
            const conferenceId = localStorage.getItem('conferenceId');
            const isVisible = localStorage.getItem('userVisibility') !== 'false';
            
            console.log('Registering user for conference:', {
                userId,
                conferenceId,
                isVisible
            });

            try {
                const baseApiUrl = 'https://cholebhature.netlify.app/api';
                const registerEndpoint = '/conference/register';
                const registerUrl = `${baseApiUrl}${registerEndpoint}`;
                
                const registerData = {
                    userId,
                    conferenceId,
                    isVisible,
                    userData: {
                        name: userData.name || `${userData.firstName} ${userData.lastName}`.trim(),
                        email: userData.email,
                        profilePicture: userData.profilePicture,
                        headline: userData.headline || 'LinkedIn User'
                    }
                };

                const response = await fetch(registerUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(registerData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to register for conference');
                }

                console.log('Successfully registered for conference');
                return await response.json();
            } catch (error) {
                console.error('Error registering for conference:', error);
                throw error;
            }
        }

        // Update visibility function to use backend
        async function updateVisibility(isVisible) {
            const status = document.getElementById('visibility-status');
            const userData = JSON.parse(localStorage.getItem('linkedInUser'));
            const userId = userData.id;
            const conferenceId = localStorage.getItem('conferenceId');
            
            console.log('Updating visibility:', {
                userId,
                conferenceId,
                isVisible
            });
            
            try {
                // First ensure user is registered for the conference
                await registerForConference();
                
                // Then update visibility status
                const visibilityUrl = getApiUrl(apiConfig.endpoints.conferenceVisibility);
                console.log('Updating visibility at URL:', visibilityUrl);
                
                const response = await fetch(visibilityUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId,
                        conferenceId,
                        isVisible,
                        userData: {
                            name: userData.name || `${userData.firstName} ${userData.lastName}`.trim(),
                            email: userData.email,
                            profilePicture: userData.profilePicture
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to update visibility');
                }

                status.textContent = isVisible ? 'Visible to Other Attendees' : 'Hidden from Other Attendees';
                localStorage.setItem('userVisibility', isVisible);
                
                // Update the visibility indicator without affecting the connections list
                const visibilityIndicator = document.createElement('div');
                visibilityIndicator.className = 'visibility-indicator';
                visibilityIndicator.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background-color: ${isVisible ? '#28a745' : '#dc3545'};
                    color: white;
                    padding: 10px 20px;
                    border-radius: 4px;
                    z-index: 1000;
                    animation: fadeOut 3s forwards;
                `;
                visibilityIndicator.textContent = isVisible ? 'You are visible to other attendees' : 'You are hidden from other attendees';
                document.body.appendChild(visibilityIndicator);
                
                // Remove the indicator after animation
                setTimeout(() => visibilityIndicator.remove(), 3000);
                
                // Refresh connections if we're visible now
                if (isVisible) {
                    setTimeout(refreshConnections, 1000);
                }
            } catch (error) {
                console.error('Error updating visibility:', error);
                alert('Failed to update visibility: ' + error.message);
                // Revert the toggle
                document.getElementById('visibility-toggle').checked = !isVisible;
            }
        }

        // Initialize visibility from stored preference
        function initializeVisibility() {
            const isVisible = localStorage.getItem('userVisibility') !== 'false';
            const visibilityToggle = document.getElementById('visibility-toggle');
            visibilityToggle.checked = isVisible;
            
            // Update the status text immediately
            const status = document.getElementById('visibility-status');
            status.textContent = isVisible ? 'Visible to Other Attendees' : 'Hidden from Other Attendees';
            
            // Register for conference and update visibility in the background
            registerForConference().catch(error => {
                console.error('Error during initialization:', error);
            });
        }

        // Add CSS for visibility indicator animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeOut {
                0% { opacity: 1; }
                70% { opacity: 1; }
                100% { opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Display user profile data
        function displayUserProfile() {
            // Get user data from localStorage
            const userData = localStorage.getItem('linkedInUser');
            if (!userData) {
                // Redirect to auth page if no user data is found
                window.location.href = 'auth.html';
                return;
            }
            
            try {
                // Parse user data
                const user = JSON.parse(userData);
                
                // Get conference info from localStorage
                const conferenceId = localStorage.getItem('conferenceId') || 'default_conference';
                const conferenceName = localStorage.getItem('conferenceName') || 'Sample Conference';
                const conferenceLocation = localStorage.getItem('conferenceLocation') || 'Virtual Event';
                
                // Store as global variables
                window.conferenceId = conferenceId;
                window.conferenceName = conferenceName;
                
                // Update conference UI
                document.getElementById('conference-name').textContent = conferenceName;
                document.getElementById('conference-location').textContent = conferenceLocation;
                
                // Update user profile info with appropriate fallbacks
                let profileName = user.name;
                if (!profileName && (user.firstName || user.lastName)) {
                    profileName = `${user.firstName || ''} ${user.lastName || ''}`.trim();
                }
                if (!profileName) {
                    profileName = user.id || 'LinkedIn User';
                }
                
                const profileEmail = user.email || 'Email not available';
                const profileHeadline = user.headline || user.currentPosition?.title || 'LinkedIn User';
                
                // For the profile picture, try multiple possible paths
                let profilePicture = user.profilePicture;
                if (!profilePicture && user.pictureUrl) {
                    profilePicture = user.pictureUrl;
                }
                if (!profilePicture && user.profilePicture?.['displayImage~']?.elements?.[0]?.identifiers?.[0]?.identifier) {
                    profilePicture = user.profilePicture['displayImage~'].elements[0].identifiers[0].identifier;
                }
                if (!profilePicture) {
                    profilePicture = 'https://randomuser.me/api/portraits/lego/1.jpg';
                }
                
                // Display user profile on the page
                updateProfileUI(profileName, profileEmail, profileHeadline, profilePicture);
                
                // Debug: Display storage information
                displayStorageDebugInfo();
                
            } catch (error) {
                console.error('Error parsing user profile:', error);
                
                // Create fallback values
                const fallbackName = 'Guest User';
                const fallbackEmail = 'guest@example.com';
                const fallbackHeadline = 'LinkedIn User';
                const fallbackPicture = 'https://randomuser.me/api/portraits/lego/1.jpg';
                
                // Display fallback user profile
                updateProfileUI(fallbackName, fallbackEmail, fallbackHeadline, fallbackPicture);
            }
        }

        // Display debug information in the debug panel
        function displayStorageDebugInfo() {
            const debugElement = document.getElementById('debug-info');
            if (!debugElement) return;
            
            try {
                const userData = JSON.parse(localStorage.getItem('linkedInUser') || '{}');
                const conferenceId = localStorage.getItem('conferenceId') || 'N/A';
                const conferenceName = localStorage.getItem('conferenceName') || 'N/A';
                const userVisible = localStorage.getItem('userVisibility') !== 'false';
                
                // Sanitize user data for display
                const sanitizedUser = { ...userData };
                if (sanitizedUser.profilePicture && sanitizedUser.profilePicture.length > 30) {
                    sanitizedUser.profilePicture = sanitizedUser.profilePicture.substring(0, 30) + '...';
                }
                
                const debugInfo = `
LinkedInUser: ${JSON.stringify(sanitizedUser, null, 2)}
ConferenceId: ${conferenceId}
ConferenceName: ${conferenceName}
UserVisibility: ${userVisible ? 'Visible' : 'Hidden'}
Last Updated: ${new Date().toLocaleTimeString()}
                `;
                
                debugElement.textContent = debugInfo;
            } catch (error) {
                console.error('Error updating debug info:', error);
                debugElement.textContent = 'Error loading debug information';
            }
        }

        // Function to refresh page
        function refreshPage() {
            window.location.reload();
        }

        // Function to clear all data
        function clearAllData() {
            localStorage.clear();
            sessionStorage.clear();
            alert('All local data cleared. The page will now reload.');
            setTimeout(refreshPage, 500);
        }

        // Function to fix test data
        function fixTestData() {
            // Create a valid user profile
            const testUser = {
                id: `test_user_${Date.now()}`,
                firstName: 'Test',
                lastName: 'User',
                name: 'Test User',
                email: 'test@example.com',
                profilePicture: 'https://randomuser.me/api/portraits/people/1.jpg',
                headline: 'Software Developer'
            };
            
            // Store the test data
            localStorage.setItem('linkedInUser', JSON.stringify(testUser));
            localStorage.setItem('isAuthenticated', 'true');
            localStorage.setItem('authTime', new Date().toISOString());
            
            // Set conference data if not already present
            if (!localStorage.getItem('conferenceId')) {
                localStorage.setItem('conferenceId', 'conf_test');
                localStorage.setItem('conferenceName', 'Test Conference');
                localStorage.setItem('conferenceLocation', 'Test Location');
            }
            
            alert('Test data has been set. Refreshing page...');
            setTimeout(refreshPage, 500);
        }

        // Display user profile UI
        function updateProfileUI(profileName, profileEmail, profileHeadline, profileImageUrl) {
            document.getElementById('profile-name').textContent = profileName;
            document.getElementById('profile-email').textContent = profileEmail;
            document.getElementById('profile-headline').textContent = profileHeadline;
            
            // Set profile image with error handling
            const profileImg = document.getElementById('profile-image');
            if (profileImg) {
                profileImg.onerror = function() { 
                    console.warn('Profile image failed to load:', this.src);
                    this.src = 'https://randomuser.me/api/portraits/lego/1.jpg'; 
                };
                profileImg.src = profileImageUrl;
            }
        }
    </script>
</body>
</html>
