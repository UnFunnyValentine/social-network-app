<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conference Connections</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background-color: #0077b5;
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: 8px 8px 0 0;
        }
        .header h1 {
            margin: 0;
            font-size: 20px;
        }
        .conference-info {
            background-color: white;
            border-radius: 0 0 8px 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .user-profile {
            display: flex;
            align-items: center;
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .profile-image {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 20px;
        }
        .profile-info h2 {
            margin: 0 0 5px 0;
            font-size: 18px;
        }
        .profile-info p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
        .section-title {
            margin: 30px 0 15px 0;
            font-size: 18px;
            color: #0077b5;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .section-title .refresh-btn {
            background-color: transparent;
            color: #0077b5;
            border: 1px solid #0077b5;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 14px;
            cursor: pointer;
        }
        .section-title .refresh-btn:hover {
            background-color: rgba(0, 119, 181, 0.1);
        }
        .connections-list {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .connection-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }
        .connection-item:last-child {
            border-bottom: none;
        }
        .connection-img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
        }
        .connection-info {
            flex: 1;
        }
        .connection-info h3 {
            margin: 0 0 5px 0;
            font-size: 16px;
        }
        .connection-info p {
            margin: 0;
            color: #666;
            font-size: 13px;
        }
        .connection-info .mutual {
            margin-top: 5px;
            font-size: 12px;
            color: #0077b5;
        }
        .connection-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }
        .btn {
            background-color: #0077b5;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            transition: background-color 0.3s;
        }
        .btn i {
            margin-right: 5px;
        }
        .btn:hover {
            background-color: #006097;
        }
        .btn-outline {
            background-color: transparent;
            color: #0077b5;
            border: 1px solid #0077b5;
        }
        .btn-outline:hover {
            background-color: rgba(0, 119, 181, 0.1);
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        .empty-state i {
            font-size: 50px;
            color: #ccc;
            margin-bottom: 15px;
        }
        .logout-btn {
            background-color: transparent;
            color: white;
            border: 1px solid white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .search-container {
            margin-bottom: 15px;
        }
        .search-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Montserrat', sans-serif;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 119, 181, 0.2);
            border-radius: 50%;
            border-top-color: #0077b5;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .conference-context {
            padding: 15px;
            background-color: #f0f7ff;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .conference-context h3 {
            margin: 0 0 10px 0;
            color: #0077b5;
        }
        .conference-context p {
            margin: 0;
            color: #555;
        }
        .search-results-info {
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .search-results-info p {
            margin: 0;
            font-style: italic;
            color: #666;
        }
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            .connection-actions {
                flex-direction: column;
                gap: 5px;
            }
        }
        /* Visibility Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin-right: 10px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
        }

        input:checked + .slider {
            background-color: #0077b5;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        .visibility-settings {
            display: flex;
            align-items: center;
            padding: 5px 0;
        }
        @keyframes fadeOut {
            0% { opacity: 1; }
            70% { opacity: 1; }
            100% { opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="container">
        <div class="header">
            <h1><i class="fab fa-linkedin"></i> LinkedIn Conference Connections</h1>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
        
        <!-- Debug panel to show actual storage data -->
        <div style="background-color: #f8f8f8; border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
            <h3 style="margin-top: 0; color: #333;">Storage Debug Info</h3>
            <div id="debug-info" style="font-family: monospace; font-size: 12px; white-space: pre-wrap;"></div>
            <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="refreshPage()" style="padding: 5px 10px; background: #0077b5; color: white; border: none; border-radius: 4px;">Refresh Page</button>
                <button onclick="fixTestData()" style="padding: 5px 10px; background: #28a745; color: white; border: none; border-radius: 4px;">Fix with Test Data</button>
                <button onclick="testLinkedInFormat()" style="padding: 5px 10px; background: #6f42c1; color: white; border: none; border-radius: 4px;">Test LinkedIn API Format</button>
                <button onclick="testLinkedInOAuth()" style="padding: 5px 10px; background: #fd7e14; color: white; border: none; border-radius: 4px;">Test LinkedIn OAuth</button>
                <button onclick="clearAllData()" style="padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px;">Clear All Data</button>
                <button onclick="goToAuth()" style="padding: 5px 10px; background: #f0ad4e; color: white; border: none; border-radius: 4px;">Go to Auth Page</button>
                <button onclick="bypassAuthCheck()" style="padding: 5px 10px; background: #5bc0de; color: white; border: none; border-radius: 4px;">Bypass Auth Check</button>
            </div>
        </div>
        
        <div class="conference-info">
            <h2 id="conference-name">Loading conference info...</h2>
            <p id="conference-location"></p>
            <p><small>Showing LinkedIn connections attending this conference</small></p>
        </div>
        
        <div class="user-profile">
            <img id="profile-image" class="profile-image" src="https://randomuser.me/api/portraits/men/1.jpg" alt="Profile Image">
            <div class="profile-info">
                <h2 id="profile-name">Loading profile...</h2>
                <p id="profile-email"></p>
                <p id="profile-headline" style="margin-top: 5px;"></p>
                <div class="visibility-settings" style="margin-top: 10px;">
                    <label class="switch">
                        <input type="checkbox" id="visibility-toggle" onchange="updateVisibility(this.checked)">
                        <span class="slider round"></span>
                    </label>
                    <span id="visibility-status">Visible to Other Attendees</span>
                </div>
            </div>
        </div>
        
        <div class="search-container">
            <input type="text" class="search-input" placeholder="Search connections..." id="searchInput">
        </div>
        
        <h2 class="section-title">
            Your Connections at this Conference
            <button class="refresh-btn" onclick="refreshConnections()"><i class="fas fa-sync-alt"></i> Refresh</button>
        </h2>
        
        <div class="connections-list" id="connections-list">
            <!-- Will be populated dynamically -->
            <div class="empty-state">
                <i class="fas fa-users"></i>
                <p>Fetching your LinkedIn connections at this conference...</p>
                <p>This may take a few moments.</p>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const apiConfig = {
            baseUrl: window.location.hostname === 'localhost' ? 'http://localhost:3000' : '/api',
            endpoints: {
                picture: '/api/linkedin/picture',
                conferenceAttendees: '/api/conference',
                conferenceRegister: '/api/conference/register',
                conferenceVisibility: '/api/conference/visibility'
            }
        };

        // Function to get full API URL
        function getApiUrl(endpoint, params = {}) {
            let url = `${apiConfig.baseUrl}${endpoint}`;
            const queryParams = new URLSearchParams();
            for (const [key, value] of Object.entries(params)) {
                queryParams.append(key, value);
            }
            const queryString = queryParams.toString();
            return queryString ? `${url}?${queryString}` : url;
        }

        // Function to generate connections from LinkedIn API
        async function generateConnections() {
            const conferenceId = localStorage.getItem('conferenceId');
            const currentUserId = JSON.parse(localStorage.getItem('linkedInUser')).id;
            
            console.log('Generating connections for:', {
                conferenceId,
                currentUserId
            });
            
            try {
                // First, ensure user is registered for the conference
                console.log('Registering for conference...');
                await registerForConference();
                
                // Then, get the conference attendees
                console.log('Fetching conference attendees...');
                const attendeesUrl = getApiUrl(`${apiConfig.endpoints.conferenceAttendees}/${conferenceId}/attendees`, { currentUserId });
                const attendeesResponse = await fetch(attendeesUrl);
                if (!attendeesResponse.ok) {
                    throw new Error('Failed to fetch conference attendees');
                }

                const attendeesData = await attendeesResponse.json();
                console.log('Conference attendees data:', JSON.stringify(attendeesData, null, 2));
                
                const attendees = attendeesData.attendees || [];

                // Process attendees with their profiles
                const conferenceAttendees = attendees.map(attendee => {
                    console.log('Processing attendee:', JSON.stringify(attendee, null, 2));
                    const profile = attendee.profile;
                    
                    if (profile) {
                        let profileUrl;
                        
                        if (profile.vanityName && !profile.vanityName.match(/^[A-Z0-9]{8,12}$/i)) {
                            profileUrl = `https://www.linkedin.com/in/${profile.vanityName}`;
                        } else if (profile.publicProfileUrl && profile.publicProfileUrl.includes('/in/')) {
                            profileUrl = profile.publicProfileUrl;
                        } else {
                            profileUrl = `search:${attendee.id}`;
                        }
                        
                        return {
                            id: attendee.id,
                            name: `${profile.firstName} ${profile.lastName}`,
                            title: profile.currentPosition?.title || profile.headline || 'Professional',
                            company: profile.currentPosition?.companyName || '',
                            pictureUrl: profile.profilePicture || getApiUrl(`${apiConfig.endpoints.picture}/${attendee.id}`),
                            profileUrl: profileUrl,
                            lastActive: Math.floor(Math.random() * 60) + 1,
                            profile: profile
                        };
                    } else {
                        return {
                            id: attendee.id,
                            name: `Attendee ${attendee.id.substring(0, 6)}`,
                            title: 'Conference Attendee',
                            company: 'Company Name',
                            pictureUrl: 'https://randomuser.me/api/portraits/men/1.jpg',
                            profileUrl: `search:${attendee.id}`,
                            lastActive: Math.floor(Math.random() * 60) + 1
                        };
                    }
                });

                return conferenceAttendees;
            } catch (error) {
                console.error('Error generating connections:', error);
                return [];
            }
        }
        
        // Function to display connections
        function displayConnections(connections, searchQuery = '') {
            console.log('Displaying connections:', {
                totalConnections: connections.length,
                searchQuery
            });
            
            // Store in global variable for use with search and other functions
            allConnections = connections;
            
            const connectionsList = document.getElementById('connections-list');
            
            // Clear existing connections
            connectionsList.innerHTML = '';
            
            // Add welcome message and conference context
            const welcomeMessage = document.createElement('div');
            welcomeMessage.className = 'conference-context';
            welcomeMessage.innerHTML = `
                <h3>Welcome, ${document.getElementById('profile-name').textContent}!</h3>
                <p>Find your connections attending "${conferenceName}" below.</p>
                <p>Total attendees: ${connections.length}</p>
            `;
            connectionsList.appendChild(welcomeMessage);
            
            // Filter connections based on search query if provided
            let filteredConnections = connections;
            if (searchQuery && searchQuery.trim() !== '') {
                const query = searchQuery.toLowerCase();
                filteredConnections = connections.filter(conn => 
                    conn.name.toLowerCase().includes(query) || 
                    conn.title.toLowerCase().includes(query) ||
                    conn.company.toLowerCase().includes(query)
                );
                
                // Add search results heading
                const searchHeading = document.createElement('div');
                searchHeading.className = 'search-results-info';
                searchHeading.innerHTML = `<p>Found ${filteredConnections.length} matching attendee(s) for "${searchQuery}"</p>`;
                connectionsList.appendChild(searchHeading);
            }
            
            if (filteredConnections.length === 0) {
                connectionsList.innerHTML += `
                    <div class="empty-state">
                        <i class="fas fa-user-slash"></i>
                        <p>No attendees found${searchQuery ? ' matching your search' : ''}.</p>
                        <p>${searchQuery ? 'Try a different search term' : 'Try refreshing the connections'}.</p>
                    </div>
                `;
            } else {
                // Display all filtered connections
                filteredConnections.forEach(connection => {
                    console.log('Displaying connection:', connection);
                    const connectionItem = createConnectionItem(connection);
                    connectionsList.appendChild(connectionItem);
                });
            }
        }
        
        // Function to create connection item element
        function createConnectionItem(connection) {
            const item = document.createElement('div');
            item.className = 'connection-item';
            
            // Create image element with error handling
            const imgElement = document.createElement('img');
            imgElement.src = connection.pictureUrl;
            imgElement.alt = connection.name;
            imgElement.className = 'connection-img';
            
            // Set up error handling for the image
            imgElement.onerror = function() {
                console.log('Profile image failed to load:', this.src);
                this.onerror = null; // Prevent infinite loop
                this.src = 'https://randomuser.me/api/portraits/men/1.jpg';
            };
            
            // Use the profile URL from the connection object
            const profileUrl = connection.profileUrl;
            console.log(`Profile URL for ${connection.name}:`, profileUrl);
            
            item.innerHTML = `
                <div class="connection-info">
                    <h3>${connection.name} <span class="status-badge">Attending ${conferenceName}</span></h3>
                    <p>${connection.title}</p>
                    ${connection.company ? `<p>${connection.company}</p>` : ''}
                    <p class="mutual">Last active ${connection.lastActive} minutes ago</p>
                </div>
                <div class="connection-actions">
                    <button class="btn btn-outline" onclick="viewProfile('${profileUrl}', '${connection.id}')">
                        <i class="fas fa-user"></i> Profile
                    </button>
                </div>
            `;
            
            // Insert the image element at the beginning
            item.insertBefore(imgElement, item.firstChild);
            
            return item;
        }
        
        // Initialize the page
        async function initializePage() {
            try {
                // Hide loading overlay immediately
                document.getElementById('loadingOverlay').style.display = 'none';
                
                // Generate and display connections
                const connections = await generateConnections();
                displayConnections(connections);
                
                // Initialize visibility
                initializeVisibility();
            } catch (error) {
                console.error('Error initializing page:', error);
                document.getElementById('loadingOverlay').style.display = 'none';
                alert('Error loading connections. Please try refreshing the page.');
            }
        }

        // Start initialization when the page loads
        document.addEventListener('DOMContentLoaded', initializePage);
        
        // Handle refreshing connections
        async function refreshConnections() {
            try {
                // Show loading overlay
                document.getElementById('loadingOverlay').style.display = 'flex';
                
                // Generate and display connections
                const connections = await generateConnections();
                displayConnections(connections);
                
                // Hide loading overlay
                document.getElementById('loadingOverlay').style.display = 'none';
            } catch (error) {
                console.error('Error refreshing connections:', error);
                document.getElementById('loadingOverlay').style.display = 'none';
                alert('Error refreshing connections. Please try again.');
            }
        }
        
        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function() {
            const searchValue = this.value.toLowerCase();
            displayConnections(allConnections, searchValue);
        });
        
        // Function to message a connection
        function messageConnection(connectionId) {
            const connection = allConnections.find(c => c.id === connectionId);
            if (connection) {
                alert(`Sending message to ${connection.name}.\n\nIn a real application, this would open a LinkedIn message dialog.`);
            }
        }
        
        // Function to view a profile
        function viewProfile(profileUrl, attendeeId) {
            console.log('Opening profile for attendee ID:', attendeeId);
            console.log('Original profile URL:', profileUrl);
            
            // Get the current user data
            const linkedInProfile = localStorage.getItem('linkedInUser');
            let currentUser = null;
            if (linkedInProfile) {
                try {
                    currentUser = JSON.parse(linkedInProfile);
                } catch (error) {
                    console.error('Error parsing LinkedIn profile:', error);
                }
            }
            
            // If this is the current user's profile, redirect to their LinkedIn feed
            if (currentUser && attendeeId === currentUser.id) {
                console.log('Opening user\'s own profile - redirecting to LinkedIn feed');
                window.open('https://www.linkedin.com/feed/', '_blank');
                return;
            }
            
            // Find the connection in our list to get the full profile data
            const connection = allConnections.find(c => c.id === attendeeId);
            console.log('Connection data for profile button click:', connection);
            
            // If the profileUrl starts with "search:", it means we don't have a valid URL
            // and need to search for the person instead
            if (profileUrl.startsWith('search:')) {
                if (connection && connection.name) {
                    const searchName = encodeURIComponent(connection.name);
                    console.log(`Using LinkedIn search for ${connection.name}`);
                    
                    // For demonstration purposes, open LinkedIn search in a new tab
                    window.open(`https://www.linkedin.com/search/results/people/?keywords=${searchName}`, '_blank');
                } else {
                    // If we can't find the connection details, just go to LinkedIn
                    console.log('No connection details found, redirecting to LinkedIn homepage');
                    window.open('https://www.linkedin.com/', '_blank');
                }
                return;
            }
            
            // Ensure the URL starts with https://
            if (!profileUrl.startsWith('http')) {
                profileUrl = 'https://' + profileUrl.replace(/^\/\//, '');
            }
            
            console.log('Final profile URL:', profileUrl);
            
            // Open the URL in a new tab
            window.open(profileUrl, '_blank');
        }
        
        // Logout function
        function logout() {
            localStorage.removeItem('isAuthenticated');
            localStorage.removeItem('linkedInUser');
            window.location.href = 'auth.html';
        }
        
        // Function to go to auth page
        function goToAuth() {
            // Create a test conference
            const testConferenceId = 'conf_' + Date.now();
            const testConferenceName = 'Conference ' + new Date().toLocaleDateString();
            const testConferenceLocation = 'Virtual';
            
            // Store in sessionStorage
            sessionStorage.setItem('conferenceId', testConferenceId);
            sessionStorage.setItem('conferenceName', testConferenceName);
            sessionStorage.setItem('conferenceLocation', testConferenceLocation);
            
            // Redirect to auth with parameters
            window.location.href = `auth.html?id=${testConferenceId}&name=${encodeURIComponent(testConferenceName)}&location=${encodeURIComponent(testConferenceLocation)}`;
        }
        
        // Function to bypass auth check
        function bypassAuthCheck() {
            window.location.href = window.location.pathname + '?bypass_auth=true';
        }
        
        // Function to test different LinkedIn profile formats
        function testLinkedInFormat() {
            // Create a test user profile with the exact LinkedIn API format
            const testProfile = {
                id: 'linkedin_test_user',
                // LinkedIn R_EMAILADDRESS scope
                emailAddress: 'test.user@example.com',
                firstName: {
                    localized: {
                        en_US: 'Test'
                    },
                    preferredLocale: {
                        country: 'US',
                        language: 'en'
                    }
                },
                lastName: {
                    localized: {
                        en_US: 'User'
                    },
                    preferredLocale: {
                        country: 'US',
                        language: 'en'
                    }
                },
                // LinkedIn API v2 format for profile picture
                profilePicture: {
                    'displayImage~': {
                        elements: [
                            {
                                identifiers: [
                                    {
                                        identifier: 'https://randomuser.me/api/portraits/men/1.jpg'
                                    }
                                ]
                            }
                        ]
                    }
                },
                // Basic profile info
                headline: 'Software Engineer at LinkedIn',
                vanityName: 'testuser',
                // Current conference info
                currentConference: {
                    id: 'conf_linkedin_test',
                    name: 'LinkedIn Developer Conference',
                    location: 'LinkedIn HQ, Sunnyvale, CA'
                }
            };
            
            // Save to localStorage
            try {
                localStorage.setItem('linkedInUser', JSON.stringify(testProfile));
                localStorage.setItem('conferenceId', testProfile.currentConference.id);
                localStorage.setItem('conferenceName', testProfile.currentConference.name);
                localStorage.setItem('conferenceLocation', testProfile.currentConference.location);
                localStorage.setItem('isAuthenticated', 'true');
                localStorage.setItem('authTime', new Date().toISOString());
                
                alert('LinkedIn API format data set in localStorage. Refreshing page...');
                setTimeout(refreshPage, 500);
            } catch (error) {
                alert('Error setting test data: ' + error.message);
            }
        }
        
        // Function to test LinkedIn OAuth response format
        function testLinkedInOAuth() {
            // Create a test user profile with the LinkedIn OAuth format
            // This is the format we get when using Sign In with LinkedIn OAuth 2.0
            const testProfile = {
                sub: "1234567890",
                name: "Jane Doe",
                given_name: "Jane",
                family_name: "Doe",
                picture: "https://randomuser.me/api/portraits/women/10.jpg",
                email: "jane.doe@example.com",
                email_verified: true,
                locale: "en_US",
                // LinkedIn specific fields
                at_hash: "abcdefghijklmnop",
                aud: "12345678",
                exp: 1616239022,
                iat: 1616235422,
                iss: "https://www.linkedin.com",
                jti: "abcdefghijklmnopqrstuvwxyz12345",
                nbf: 1616235422,
                nonce: "abcdefghijklmnopqrstuvwxyz12345",
                // Conference information
                conference: {
                    id: "conf_oidc_test",
                    name: "OAuth Test Conference",
                    location: "Virtual Event"
                }
            };
            
            // Save to localStorage
            try {
                localStorage.setItem('linkedInUser', JSON.stringify(testProfile));
                localStorage.setItem('conferenceId', testProfile.conference.id);
                localStorage.setItem('conferenceName', testProfile.conference.name);
                localStorage.setItem('conferenceLocation', testProfile.conference.location);
                localStorage.setItem('isAuthenticated', 'true');
                localStorage.setItem('authTime', new Date().toISOString());
                
                alert('LinkedIn OAuth format data set in localStorage. Refreshing page...');
                setTimeout(refreshPage, 500);
            } catch (error) {
                alert('Error setting OAuth test data: ' + error.message);
            }
        }
        
        // Register user for conference
        async function registerForConference() {
            const userId = JSON.parse(localStorage.getItem('linkedInUser')).id;
            const conferenceId = localStorage.getItem('conferenceId');
            const isVisible = localStorage.getItem('userVisibility') !== 'false';

            try {
                const response = await fetch(getApiUrl(apiConfig.endpoints.conferenceRegister), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId,
                        conferenceId,
                        isVisible
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to register for conference');
                }

                console.log('Successfully registered for conference');
            } catch (error) {
                console.error('Error registering for conference:', error);
                throw error;
            }
        }

        // Update visibility function to use backend
        async function updateVisibility(isVisible) {
            const status = document.getElementById('visibility-status');
            const userId = JSON.parse(localStorage.getItem('linkedInUser')).id;
            const conferenceId = localStorage.getItem('conferenceId');
            
            try {
                // First ensure user is registered for the conference
                await registerForConference();
                
                const response = await fetch(getApiUrl(apiConfig.endpoints.conferenceVisibility), {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId,
                        conferenceId,
                        isVisible
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to update visibility');
                }

                status.textContent = isVisible ? 'Visible to Other Attendees' : 'Hidden from Other Attendees';
                localStorage.setItem('userVisibility', isVisible);
                
                // Update the visibility indicator without affecting the connections list
                const visibilityIndicator = document.createElement('div');
                visibilityIndicator.className = 'visibility-indicator';
                visibilityIndicator.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background-color: ${isVisible ? '#28a745' : '#dc3545'};
                    color: white;
                    padding: 10px 20px;
                    border-radius: 4px;
                    z-index: 1000;
                    animation: fadeOut 3s forwards;
                `;
                visibilityIndicator.textContent = isVisible ? 'You are visible to other attendees' : 'You are hidden from other attendees';
                document.body.appendChild(visibilityIndicator);
                
                // Remove the indicator after animation
                setTimeout(() => visibilityIndicator.remove(), 3000);
            } catch (error) {
                console.error('Error updating visibility:', error);
                alert('Failed to update visibility: ' + error.message);
                // Revert the toggle
                document.getElementById('visibility-toggle').checked = !isVisible;
            }
        }

        // Initialize visibility from stored preference
        function initializeVisibility() {
            const isVisible = localStorage.getItem('userVisibility') !== 'false';
            const visibilityToggle = document.getElementById('visibility-toggle');
            visibilityToggle.checked = isVisible;
            
            // Update the status text immediately
            const status = document.getElementById('visibility-status');
            status.textContent = isVisible ? 'Visible to Other Attendees' : 'Hidden from Other Attendees';
            
            // Register for conference and update visibility in the background
            registerForConference().catch(error => {
                console.error('Error during initialization:', error);
            });
        }

        // Add CSS for visibility indicator animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeOut {
                0% { opacity: 1; }
                70% { opacity: 1; }
                100% { opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Display user profile data
        function updateProfileUI(profileName, profileEmail, profileHeadline, profileImageUrl) {
            document.getElementById('profile-name').textContent = profileName;
            document.getElementById('profile-email').textContent = profileEmail;
            document.getElementById('profile-headline').textContent = profileHeadline;
            
            // Set profile image with error handling
            const profileImg = document.getElementById('profile-image');
            if (profileImg) {
                profileImg.onerror = function() { 
                    console.warn('Profile image failed to load:', this.src);
                    this.src = 'https://randomuser.me/api/portraits/men/1.jpg'; 
                };
                profileImg.src = profileImageUrl;
            }
        }
    </script>
</body>
</html>