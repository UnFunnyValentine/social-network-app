<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conference Connections</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background-color: #0077b5;
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: 8px 8px 0 0;
        }
        .header h1 {
            margin: 0;
            font-size: 20px;
        }
        .conference-info {
            background-color: white;
            border-radius: 0 0 8px 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .user-profile {
            display: flex;
            align-items: center;
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .profile-image {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 20px;
        }
        .profile-info h2 {
            margin: 0 0 5px 0;
            font-size: 18px;
        }
        .profile-info p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
        .section-title {
            margin: 30px 0 15px 0;
            font-size: 18px;
            color: #0077b5;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .section-title .refresh-btn {
            background-color: transparent;
            color: #0077b5;
            border: 1px solid #0077b5;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 14px;
            cursor: pointer;
        }
        .section-title .refresh-btn:hover {
            background-color: rgba(0, 119, 181, 0.1);
        }
        .connections-list {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .connection-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }
        .connection-item:last-child {
            border-bottom: none;
        }
        .connection-img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
        }
        .connection-info {
            flex: 1;
        }
        .connection-info h3 {
            margin: 0 0 5px 0;
            font-size: 16px;
        }
        .connection-info p {
            margin: 0;
            color: #666;
            font-size: 13px;
        }
        .connection-info .mutual {
            margin-top: 5px;
            font-size: 12px;
            color: #0077b5;
        }
        .connection-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }
        .btn {
            background-color: #0077b5;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            transition: background-color 0.3s;
        }
        .btn i {
            margin-right: 5px;
        }
        .btn:hover {
            background-color: #006097;
        }
        .btn-outline {
            background-color: transparent;
            color: #0077b5;
            border: 1px solid #0077b5;
        }
        .btn-outline:hover {
            background-color: rgba(0, 119, 181, 0.1);
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        .empty-state i {
            font-size: 50px;
            color: #ccc;
            margin-bottom: 15px;
        }
        .logout-btn {
            background-color: transparent;
            color: white;
            border: 1px solid white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .search-container {
            margin-bottom: 15px;
        }
        .search-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Montserrat', sans-serif;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 119, 181, 0.2);
            border-radius: 50%;
            border-top-color: #0077b5;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .conference-context {
            padding: 15px;
            background-color: #f0f7ff;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .conference-context h3 {
            margin: 0 0 10px 0;
            color: #0077b5;
        }
        .conference-context p {
            margin: 0;
            color: #555;
        }
        .search-results-info {
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .search-results-info p {
            margin: 0;
            font-style: italic;
            color: #666;
        }
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            .connection-actions {
                flex-direction: column;
                gap: 5px;
            }
        }
        /* Visibility Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin-right: 10px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
        }

        input:checked + .slider {
            background-color: #0077b5;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        .visibility-settings {
            display: flex;
            align-items: center;
            padding: 5px 0;
        }
        @keyframes fadeOut {
            0% { opacity: 1; }
            70% { opacity: 1; }
            100% { opacity: 0; }
        }
        .btn-share {
            background-color: #0077b5;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            margin-right: 10px;
            display: inline-flex;
            align-items: center;
        }
        .btn-share i {
            margin-right: 5px;
        }
        .btn-share:hover {
            background-color: #006097;
        }
        .share-buttons {
            margin-top: 15px;
        }
        .qr-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 90%;
            max-width: 350px;
            text-align: center;
        }
        .qr-dialog h3 {
            margin-top: 0;
        }
        .qr-dialog #qrcode {
            padding: 20px;
            background: white;
            display: inline-block;
            margin: 20px auto;
        }
        .dialog-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="container">
        <div class="header">
            <h1><i class="fab fa-linkedin"></i> LinkedIn Conference Connections</h1>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
        
        <div class="conference-info">
            <h2 id="conference-name">Loading conference info...</h2>
            <p id="conference-location"></p>
            <p><small>Showing LinkedIn connections attending this conference</small></p>
            <div class="share-buttons">
                <button class="btn btn-share" onclick="showQRCode()">
                    <i class="fas fa-qrcode"></i> Share QR Code
                </button>
                <button class="btn btn-share" onclick="showShareOptions()">
                    <i class="fas fa-link"></i> Share Link
                </button>
            </div>
        </div>
        
        <div class="user-profile">
            <img id="profile-image" class="profile-image" src="https://randomuser.me/api/portraits/men/1.jpg" alt="Profile Image">
            <div class="profile-info">
                <h2 id="profile-name">Loading profile...</h2>
                <p id="profile-email"></p>
                <p id="profile-headline" style="margin-top: 5px;"></p>
                <div class="visibility-settings" style="margin-top: 10px;">
                    <label class="switch">
                        <input type="checkbox" id="visibility-toggle" onchange="updateVisibility(this.checked)">
                        <span class="slider round"></span>
                    </label>
                    <span id="visibility-status">Visible to Other Attendees</span>
                </div>
            </div>
        </div>
        
        <div class="search-container">
            <input type="text" class="search-input" placeholder="Search connections..." id="searchInput">
        </div>
        
        <h2 class="section-title">
            All Conference Attendees
            <button class="refresh-btn" onclick="refreshConnections()"><i class="fas fa-sync-alt"></i> Refresh</button>
        </h2>
        
        <div class="connections-list" id="connections-list">
            <!-- Will be populated dynamically -->
            <div class="empty-state">
                <i class="fas fa-users"></i>
                <p>Fetching your LinkedIn connections at this conference...</p>
                <p>This may take a few moments.</p>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const apiConfig = {
            baseUrl: 'https://cholebhature.netlify.app/api',
            endpoints: {
                // LinkedIn endpoints
                profile: '/linkedin/profile',
                connections: '/linkedin/connections',
                picture: '/linkedin/picture',
                
                // Conference endpoints
                conferenceAttendees: '/conference',
                conferenceRegister: '/conference/register',
                conferenceVisibility: '/conference/visibility',
                conferenceRecommendations: '/conference/recommendations'
            }
        };

        // Function to get full API URL
        function getApiUrl(endpoint, params = {}) {
            // Ensure the endpoint starts with a slash
            if (!endpoint.startsWith('/')) {
                endpoint = '/' + endpoint;
            }
            
            let url = `${apiConfig.baseUrl}${endpoint}`;
            
            // Add parameters if provided
            if (Object.keys(params).length > 0) {
                const queryParams = new URLSearchParams();
                for (const [key, value] of Object.entries(params)) {
                    queryParams.append(key, value);
                }
                const queryString = queryParams.toString();
                url = queryString ? `${url}?${queryString}` : url;
            }
            
            console.log('Generated API URL:', url);
            return url;
        }

        // Function to automatically refresh connections periodically
        let autoRefreshInterval = null;

        // Add client-side attendee storage system for reliability
        let clientSideAttendees = {};

        // Helper function to store attendee locally
        function storeAttendeeLocally(conferenceId, userId, userData) {
            // Get existing attendees for this conference
            try {
                // Load from sessionStorage first
                clientSideAttendees = JSON.parse(sessionStorage.getItem('clientSideAttendees') || '{}');
                
                // Ensure the conference exists
                if (!clientSideAttendees[conferenceId]) {
                    clientSideAttendees[conferenceId] = {};
                }
                
                // Add the user to the conference
                clientSideAttendees[conferenceId][userId] = {
                    id: userId,
                    isVisible: true,
                    timestamp: Date.now(),
                    profile: userData
                };
                
                // Save back to sessionStorage
                sessionStorage.setItem('clientSideAttendees', JSON.stringify(clientSideAttendees));
                console.log(`Stored attendee ${userId} locally for conference ${conferenceId}`);
            } catch (error) {
                console.error('Error storing attendee locally:', error);
            }
        }
        
        // Helper function to get locally stored attendees
        function getLocalAttendees(conferenceId) {
            try {
                // Load from sessionStorage
                clientSideAttendees = JSON.parse(sessionStorage.getItem('clientSideAttendees') || '{}');
                
                // Return attendees for this conference
                if (clientSideAttendees[conferenceId]) {
                    return Object.values(clientSideAttendees[conferenceId]);
                }
            } catch (error) {
                console.error('Error getting local attendees:', error);
            }
            
            return [];
        }
        
        // Helper function to broadcast user presence
        function broadcastAttendance() {
            const userData = JSON.parse(localStorage.getItem('linkedInUser'));
            const userId = userData.id || userData.sub;
            const conferenceId = localStorage.getItem('conferenceId');
            
            if (!userId || !conferenceId) return;
            
            // Create profile data
            let name = userData.name;
            if (!name && (userData.firstName || userData.lastName)) {
                name = `${userData.firstName || ''} ${userData.lastName || ''}`.trim();
            }
            if (!name && (userData.given_name || userData.family_name)) {
                name = `${userData.given_name || ''} ${userData.family_name || ''}`.trim();
            }
            
            const profileData = {
                id: userId,
                name: name || 'Conference Attendee',
                email: userData.email || userData.emailAddress || 'email@example.com',
                headline: userData.headline || userData.title || '',
                company: userData.company || userData.currentPosition?.companyName || '',
                title: userData.title || userData.headline || '',
                profilePicture: userData.profilePicture || userData.pictureUrl || userData.picture || ''
            };
            
            // Store locally
            storeAttendeeLocally(conferenceId, userId, profileData);
            
            // Also try to store on server
            registerForConference().catch(err => console.error('Failed to register with server:', err));
        }

        // Function to generate connections from LinkedIn API
        async function generateConnections(silent = false) {
            const conferenceId = localStorage.getItem('conferenceId');
            const currentUserId = JSON.parse(localStorage.getItem('linkedInUser')).id;
            
            console.log('Generating connections for:', {
                conferenceId,
                currentUserId,
                silent
            });
            
            try {
                // First, ensure user is registered with both local and server storage
                console.log('Registering for conference...');
                broadcastAttendance();
                
                // Try to get attendees from server first
                let serverAttendees = [];
                let hadServerSuccess = false;
                
                try {
                    // Try both API formats
                    const netlifyFormat = `/.netlify/functions/conference-attendees?conferenceId=${encodeURIComponent(conferenceId)}&currentUserId=${encodeURIComponent(currentUserId)}&_t=${Date.now()}`;
                    
                    // Show loading overlay while fetching if not silent
                    if (!silent) {
                        document.getElementById('loadingOverlay').style.display = 'flex';
                    }
                    
                    const response = await fetch(netlifyFormat, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Cache-Control': 'no-cache, no-store'
                        }
                    });
                    
                    if (response.ok) {
                        const attendeesData = await response.json();
                        if (attendeesData && attendeesData.attendees && attendeesData.attendees.length > 0) {
                            serverAttendees = attendeesData.attendees;
                            hadServerSuccess = true;
                            console.log(`Got ${serverAttendees.length} attendees from server`);
                        }
                    }
                } catch (apiError) {
                    console.error('Error getting attendees from server:', apiError);
                }
                
                // Get local attendees
                const localAttendees = getLocalAttendees(conferenceId);
                console.log(`Got ${localAttendees.length} attendees from client storage`);
                
                // Broadcast attendance again to ensure we're registered
                broadcastAttendance();
                
                // Merge server and local attendees, preferring server data
                const allAttendeeIds = new Set();
                const mergedAttendees = [];
                
                // Add server attendees first
                serverAttendees.forEach(attendee => {
                    const id = attendee.id || attendee.profile?.id;
                    if (id) {
                        allAttendeeIds.add(id);
                        mergedAttendees.push(attendee);
                    }
                });
                
                // Add local attendees if not already in merged list
                localAttendees.forEach(attendee => {
                    const id = attendee.id || attendee.profile?.id;
                    if (id && !allAttendeeIds.has(id)) {
                        allAttendeeIds.add(id);
                        mergedAttendees.push(attendee);
                    }
                });
                
                console.log(`Merged ${mergedAttendees.length} total attendees`);
                
                // Process and return the attendees
                return processAttendees(mergedAttendees);
                
            } catch (error) {
                console.error('Error generating connections:', error);
                
                // Fallback to local storage only
                try {
                    const localAttendees = getLocalAttendees(conferenceId);
                    
                    // If we have local attendees, return them
                    if (localAttendees.length > 0) {
                        console.log(`Using ${localAttendees.length} local attendees as fallback`);
                        return processAttendees(localAttendees);
                    }
                } catch (localError) {
                    console.error('Error with local attendee fallback:', localError);
                }
                
                // Return empty array
                return [];
            } finally {
                // Hide loading overlay if not silent
                if (!silent) {
                    document.getElementById('loadingOverlay').style.display = 'none';
                }
            }
        }

        // Register user for conference - fixed to work with the API
        async function registerForConference() {
            const userData = JSON.parse(localStorage.getItem('linkedInUser'));
            const userId = userData.id || userData.sub;
            const conferenceId = localStorage.getItem('conferenceId');
            const isVisible = localStorage.getItem('userVisibility') !== 'false';
            
            console.log('Registering user for conference:', {
                userId,
                conferenceId,
                isVisible
            });

            // Create standardized profile data
            // Normalize data from various LinkedIn API formats
            let name = userData.name;
            if (!name && (userData.firstName || userData.lastName)) {
                name = `${userData.firstName || ''} ${userData.lastName || ''}`.trim();
            }
            if (!name && (userData.given_name || userData.family_name)) {
                name = `${userData.given_name || ''} ${userData.family_name || ''}`.trim();
            }
            
            // Normalize email
            const email = userData.email || userData.emailAddress || 'email@example.com';
            
            // Normalize profile picture
            let profilePicture = userData.profilePicture || userData.pictureUrl || userData.picture;
            if (typeof profilePicture === 'object' && profilePicture?.['displayImage~']?.elements?.[0]?.identifiers?.[0]?.identifier) {
                profilePicture = profilePicture['displayImage~'].elements[0].identifiers[0].identifier;
            }
            
            // Create standardized profile data
            const profileData = {
                id: userId,
                name: name || 'Conference Attendee',
                email: email,
                profilePicture: profilePicture || '',
                headline: userData.headline || userData.title || '',
                company: userData.company || userData.currentPosition?.companyName || '',
                title: userData.title || userData.headline || '',
                joinedAt: new Date().toISOString(),
                // Use the LinkedIn URL directly from userData if it exists
                linkedinUrl: userData.linkedinUrl || '',
                // Include vanity name if it exists
                vanityName: userData.vanityName || ''
            };
            
            console.log('Profile data includes LinkedIn URL:', profileData.linkedinUrl);
            
            // Always store locally for reliability
            storeAttendeeLocally(conferenceId, userId, profileData);

            try {
                // Use properly formatted API URL with Netlify redirects
                const registerUrl = '/.netlify/functions/conference-register';
                
                // Add user ID and conference ID to the profile data
                const apiProfileData = {
                    userId,
                    conferenceId,
                    isVisible,
                    userData: profileData
                };

                console.log('Sending registration data:', JSON.stringify(apiProfileData));

                // Try both netlify function path and standard API path
                let registered = false;
                let error = null;
                
                // 1. Try Netlify Functions path
                try {
                    const response = await fetch(registerUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'Cache-Control': 'no-cache, no-store'
                        },
                        body: JSON.stringify(apiProfileData)
                    });

                    if (response.ok) {
                        console.log('Successfully registered using Netlify Functions path');
                        registered = true;
                        try {
                            return await response.json();
                        } catch (e) {
                            return { success: true, method: 'netlify' };
                        }
                    } else {
                        const errorText = await response.text();
                        console.error('Netlify registration error:', errorText);
                        error = new Error(`Netlify registration failed: ${response.status} ${response.statusText}`);
                    }
                } catch (netlifyError) {
                    console.error('Error with Netlify registration:', netlifyError);
                    error = netlifyError;
                }
                
                // 2. Try standard API path if Netlify path failed
                if (!registered) {
                    try {
                        const fallbackUrl = '/api/conference/register';
                        console.log('Trying alternative API URL:', fallbackUrl);
                        
                        const fallbackResponse = await fetch(fallbackUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json',
                                'Cache-Control': 'no-cache, no-store'
                            },
                            body: JSON.stringify(apiProfileData)
                        });
                        
                        if (fallbackResponse.ok) {
                            console.log('Successfully registered using standard API path');
                            registered = true;
                            try {
                                return await fallbackResponse.json();
                            } catch (e) {
                                return { success: true, method: 'standard' };
                            }
                        } else {
                            const fallbackErrorText = await fallbackResponse.text();
                            console.error('Standard API registration error:', fallbackErrorText);
                            error = new Error(`Standard API registration failed: ${fallbackResponse.status} ${fallbackResponse.statusText}`);
                        }
                    } catch (standardError) {
                        console.error('Error with standard API registration:', standardError);
                        error = standardError;
                    }
                }
                
                // Client-side storage worked even if server storage failed
                return { success: true, method: 'client_side', error: error?.message };
                
            } catch (error) {
                console.error('Error registering for conference:', error);
                // We still stored locally, so this isn't a total failure
                return { success: true, method: 'client_side_only', error: error.message };
            }
        }

        // Initialize the page
        async function initializePage() {
            try {
                console.log('Initializing page...');
                
                // Check if user is authenticated
                const userData = localStorage.getItem('linkedInUser');
                if (!userData) {
                    console.error('No user data found, redirecting to auth page');
                    window.location.href = 'auth.html';
                    return;
                }
                
                // Check if conference info is set
                const conferenceId = localStorage.getItem('conferenceId');
                if (!conferenceId) {
                    console.error('No conference ID found');
                    alert('Conference ID is missing. Please try again with a valid conference link.');
                    return;
                }
                
                // Display user profile first
                displayUserProfile();
                
                // Hide loading overlay immediately
                document.getElementById('loadingOverlay').style.display = 'none';
                
                // Broadcast attendance - this stores the current user in both local and server storage
                broadcastAttendance();
                
                // Short delay to ensure registration is processed
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Generate and display connections
                const connections = await generateConnections();
                displayConnections(connections);
                
                // Initialize visibility
                initializeVisibility();
                
                // Get server debug info
                const debugInfo = await fetchDebugInfo();
                updateDebugPanel(debugInfo);
                
                // Set up auto-refresh
                startAutoRefresh(15000); // Every 15 seconds
                
                console.log('Page initialization complete.');
            } catch (error) {
                console.error('Error initializing page:', error);
                document.getElementById('loadingOverlay').style.display = 'none';
                alert('Error loading connections. Please try refreshing the page.');
            }
        }

        // Start automatic refresh - but use a longer interval
        function startAutoRefresh(intervalMs = 30000) { // Every 30 seconds
            // Clear any existing interval
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            // Set new interval for auto-refresh
            console.log(`Starting auto-refresh with interval: ${intervalMs}ms`);
            
            autoRefreshInterval = setInterval(async () => {
                console.log('Auto-refreshing connections...');
                try {
                    // Silently refresh without showing loading overlay
                    const connections = await generateConnections(true);
                    
                    // Also update debug info
                    const debugInfo = await fetchDebugInfo();
                    updateDebugPanel(debugInfo);
                    
                    // If connections are different from current list, update the display
                    const currentCount = allConnections ? allConnections.length : 0;
                    
                    if (connections.length !== currentCount) {
                        console.log(`Updating connections: was ${currentCount}, now ${connections.length}`);
                        displayConnections(connections);
                        
                        // Show a small notification that new attendees were found
                        if (connections.length > currentCount) {
                            const newCount = connections.length - currentCount;
                            const refreshIndicator = document.createElement('div');
                            refreshIndicator.className = 'visibility-indicator';
                            refreshIndicator.style.cssText = `
                                position: fixed;
                                top: 20px;
                                right: 20px;
                                background-color: #28a745;
                                color: white;
                                padding: 10px 20px;
                                border-radius: 4px;
                                z-index: 1000;
                                animation: fadeOut 3s forwards;
                            `;
                            refreshIndicator.textContent = `Found ${newCount} new attendee${newCount === 1 ? '' : 's'}`;
                            document.body.appendChild(refreshIndicator);
                            
                            // Remove the indicator after animation
                            setTimeout(() => refreshIndicator.remove(), 3000);
                        }
                    }
                } catch (error) {
                    console.warn('Auto-refresh error:', error);
                    // Don't show error to user, just log it
                }
            }, intervalMs);
        }

        // Stop automatic refresh
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        // Function to display connections
        function displayConnections(connections, searchQuery = '') {
            console.log('Displaying connections:', {
                totalConnections: connections.length,
                searchQuery
            });
            
            // Store in global variable for use with search and other functions
            allConnections = connections;
            
            const connectionsList = document.getElementById('connections-list');
            
            // Clear existing connections
            connectionsList.innerHTML = '';
            
            // Get debug data to show in the debug panel
            fetchDebugInfo().then(debugInfo => {
                updateDebugPanel(debugInfo);
            });
            
            // Add welcome message and conference context
            const welcomeMessage = document.createElement('div');
            welcomeMessage.className = 'conference-context';
            
            const userName = document.getElementById('profile-name').textContent;
            
            welcomeMessage.innerHTML = `
                <h3>Welcome, ${userName}!</h3>
                <p>Conference: "${conferenceName}"</p>
                <p>${connections.length > 0 
                    ? `Showing ${connections.length} attendee${connections.length === 1 ? '' : 's'}` 
                    : 'No other attendees found yet'}
                </p>
            `;
            connectionsList.appendChild(welcomeMessage);
            
            // Filter connections based on search query if provided
            let filteredConnections = connections;
            if (searchQuery && searchQuery.trim() !== '') {
                const query = searchQuery.toLowerCase();
                filteredConnections = connections.filter(conn => 
                    conn.name.toLowerCase().includes(query) || 
                    conn.title.toLowerCase().includes(query) ||
                    conn.company.toLowerCase().includes(query)
                );
                
                // Add search results heading
                const searchHeading = document.createElement('div');
                searchHeading.className = 'search-results-info';
                searchHeading.innerHTML = `<p>Found ${filteredConnections.length} matching attendee(s) for "${searchQuery}"</p>`;
                connectionsList.appendChild(searchHeading);
            }
            
            if (filteredConnections.length === 0) {
                // No connections found, show appropriate message
                if (connections.length > 0 && searchQuery) {
                    // We have connections but search returned no results
                    connectionsList.innerHTML += `
                        <div class="empty-state">
                            <i class="fas fa-search"></i>
                            <p>No attendees found matching your search.</p>
                            <p>Try a different search term or clear the search box.</p>
                        </div>
                    `;
                } else if (searchQuery) {
                    // No connections and search was performed
                    connectionsList.innerHTML += `
                        <div class="empty-state">
                            <i class="fas fa-search"></i>
                            <p>No attendees found matching your search.</p>
                            <p>You're currently the only attendee at this conference.</p>
                        </div>
                    `;
                } else {
                    // No connections and no search, fresh empty state
                    connectionsList.innerHTML += `
                        <div class="empty-state">
                            <i class="fas fa-user-friends"></i>
                            <p>You're the only attendee at this conference right now.</p>
                            <p>Invite others to join this conference!</p>
                            <div>
                                <button class="btn" onclick="showShareOptions()" style="margin-top: 15px;">
                                    <i class="fas fa-share-alt"></i> Share Conference Link
                                </button>
                            </div>
                        </div>
                    `;
                }
            } else {
                // Display all filtered connections
                filteredConnections.forEach(connection => {
                    console.log('Displaying connection:', connection);
                    const connectionItem = createConnectionItem(connection);
                    connectionsList.appendChild(connectionItem);
                });
            }
        }
        
        // Function to create connection item with better image handling
        const createConnectionItem = function(connection) {
            const item = document.createElement('div');
            item.className = 'connection-item';
            
            // Create an image element with a data URI fallback that shows initials
            const imgElement = document.createElement('img');
            const initials = connection.name ? connection.name.charAt(0).toUpperCase() : '?';
            const initialsImage = `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="50" height="50"><circle cx="25" cy="25" r="25" fill="rgb(0, 119, 181)"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" fill="white" font-size="20">${initials}</text></svg>`;
            
            // Set attributes to help with privacy browsers like Brave
            imgElement.crossOrigin = "anonymous";
            imgElement.referrerPolicy = "no-referrer";
            imgElement.className = 'connection-img';
            imgElement.alt = connection.name;
            
            // Set the src last, in case the URL is invalid
            if (connection.pictureUrl) {
                imgElement.src = connection.pictureUrl;
            } else {
                imgElement.src = initialsImage;
            }
            
            // If the image fails to load, show initials instead
            imgElement.onerror = function() {
                console.log('Profile image failed to load:', this.src);
                this.onerror = null; // Prevent infinite loop
                this.src = initialsImage;
            };
            
            // Use the profile URL from the connection object, properly escaped for HTML
            const profileUrl = connection.profileUrl || '';
            // Properly escape quotes and HTML characters for safe insertion into HTML attributes
            const escapedProfileUrl = profileUrl.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            const escapedId = connection.id.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            
            // Check if this is the current user
            const currentUserId = JSON.parse(localStorage.getItem('linkedInUser')).id;
            const isCurrentUser = connection.id === currentUserId;
            
            // Show title and company if available
            let titleHtml = '';
            if (connection.title || connection.company) {
                titleHtml = `<p>${connection.title || ''}${connection.title && connection.company ? ' at ' : ''}${connection.company || ''}</p>`;
            }
            
            item.innerHTML = `
                <div class="connection-info">
                    <h3>${connection.name} 
                        ${isCurrentUser ? '<span class="status-badge" style="background-color: #e3f2fd; color: #0d47a1;">You</span>' : 
                        '<span class="status-badge">Attending ' + conferenceName + '</span>'}
                    </h3>
                    ${titleHtml}
                </div>
                <div class="connection-actions">
                    <button class="btn btn-outline" onclick="viewProfile('${escapedProfileUrl}', '${escapedId}')">
                        <i class="fas fa-user"></i> Profile
                    </button>
                </div>
            `;
            
            // Insert the image element at the beginning
            item.insertBefore(imgElement, item.firstChild);
            
            return item;
        };
        
        // Function to refresh connections
        async function refreshConnections() {
            try {
                // Show loading overlay
                document.getElementById('loadingOverlay').style.display = 'flex';
                
                // Call debugProfileUrls after a short delay
                setTimeout(debugProfileUrls, 3000);
                
                // Clear any cached connections data
                allConnections = [];
                
                // Empty the current connections list to show it's refreshing
                const connectionsList = document.getElementById('connections-list');
                connectionsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-sync-alt fa-spin"></i>
                        <p>Refreshing attendee data...</p>
                        <p>Checking for attendees at this conference.</p>
                    </div>
                `;
                
                // Register for conference to ensure we're registered
                const registerResult = await registerForConference();
                console.log('Registration result during refresh:', registerResult);
                
                // Add a short delay to ensure registration is processed
                await new Promise(resolve => setTimeout(resolve, 800));
                
                // Generate and display connections
                const connections = await generateConnections();
                
                // Request backend debug info
                const debugInfo = await fetchDebugInfo();
                updateDebugPanel(debugInfo);
                
                // If we get data back, display it
                if (connections && connections.length > 0) {
                    console.log(`Refreshed ${connections.length} connections successfully`);
                    displayConnections(connections);
                } else {
                    // Always include at least the current user
                    const userData = JSON.parse(localStorage.getItem('linkedInUser'));
                    const currentUser = {
                        id: userData.id || userData.sub,
                        name: userData.name || `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || 'You',
                        title: userData.headline || userData.title || 'Conference Attendee',
                        company: userData.company || '',
                        pictureUrl: userData.profilePicture || userData.pictureUrl || userData.picture || 'https://randomuser.me/api/portraits/people/1.jpg',
                        profileUrl: 'https://www.linkedin.com/feed/',
                        lastActive: 0
                    };
                    
                    console.log('No attendees from API, but showing current user:', currentUser);
                    displayConnections([currentUser]);
                    
                    // Update UI to show no other attendees found
                    const welcomeMessage = connectionsList.querySelector('.conference-context');
                    if (welcomeMessage) {
                        welcomeMessage.innerHTML = `
                            <h3>Welcome, ${currentUser.name}!</h3>
                            <p>Conference: "${localStorage.getItem('conferenceName')}"</p>
                            <p>You're the only attendee right now. Share this conference to invite others!</p>
                            <button class="btn" onclick="showShareOptions()" style="margin-top: 10px;">
                                <i class="fas fa-share-alt"></i> Share Conference Link
                            </button>
                        `;
                    }
                }
                
                // Hide loading overlay
                document.getElementById('loadingOverlay').style.display = 'none';
                
                // Show success message
                const successIndicator = document.createElement('div');
                successIndicator.className = 'visibility-indicator';
                successIndicator.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background-color: #28a745;
                    color: white;
                    padding: 10px 20px;
                    border-radius: 4px;
                    z-index: 1000;
                    animation: fadeOut 3s forwards;
                `;
                successIndicator.textContent = 'Refreshed successfully';
                document.body.appendChild(successIndicator);
                
                // Remove the indicator after animation
                setTimeout(() => successIndicator.remove(), 3000);
                
            } catch (error) {
                console.error('Error refreshing connections:', error);
                
                // Hide loading overlay
                document.getElementById('loadingOverlay').style.display = 'none';
                
                // Show error message in connections list
                const connectionsList = document.getElementById('connections-list');
                connectionsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i>
                        <p>Error refreshing attendee list: ${error.message}</p>
                        <p>Please try again later.</p>
                        <button class="btn" onclick="refreshConnections()">
                            <i class="fas fa-sync-alt"></i> Try Again
                        </button>
                    </div>
                `;
            }
        }
        
        // Function to fetch debug info from the server
        async function fetchDebugInfo() {
            try {
                const debugUrl = '/.netlify/functions/debug-store?action=get_debug_info';
                const response = await fetch(debugUrl, {
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache, no-store' 
                    }
                });
                
                if (!response.ok) {
                    console.error('Error fetching debug info:', response.status, response.statusText);
                    return null;
                }
                
                const data = await response.json();
                console.log('Debug info:', data);
                return data;
            } catch (error) {
                console.error('Error fetching debug info:', error);
                return null;
            }
        }

        // Function to update the debug panel with info
        function updateDebugPanel(debugInfo) {
            const debugPanel = document.getElementById('debug-info');
            if (!debugPanel) return;
            
            try {
                // Get info about the current user and conference
                const userData = JSON.parse(localStorage.getItem('linkedInUser') || '{}');
                const conferenceId = localStorage.getItem('conferenceId') || 'N/A';
                const conferenceName = localStorage.getItem('conferenceName') || 'N/A';
                const userVisible = localStorage.getItem('userVisibility') !== 'false';
                
                // Build debug info string
                let debugStr = `Conference ID: ${conferenceId}\n`;
                debugStr += `Conference Name: ${conferenceName}\n`;
                debugStr += `Current User: ${userData.name || userData.id || 'Unknown'} (${userData.id || 'No ID'})\n`;
                debugStr += `User Visibility: ${userVisible ? 'Visible' : 'Hidden'}\n\n`;
                
                // Add server info if available
                if (debugInfo && debugInfo.debugInfo) {
                    debugStr += 'Server Data:\n';
                    
                    if (debugInfo.debugInfo[conferenceId]) {
                        const confInfo = debugInfo.debugInfo[conferenceId];
                        debugStr += `- Total Attendees: ${confInfo.totalAttendees}\n`;
                        debugStr += `- Visible Attendees: ${confInfo.visibleAttendees}\n`;
                        
                        if (confInfo.attendeeIds && confInfo.attendeeIds.length > 0) {
                            debugStr += `- Attendee IDs: ${JSON.stringify(confInfo.attendeeIds)}\n`;
                            debugStr += `- Current User is in list: ${confInfo.attendeeIds.includes(userData.id) ? 'Yes' : 'No'}\n`;
                        }
                    } else {
                        debugStr += '- Conference not found on server\n';
                    }
                } else {
                    debugStr += 'Server Data: Unable to fetch\n';
                }
                
                // Update the debug panel
                debugPanel.textContent = debugStr;
            } catch (error) {
                console.error('Error updating debug panel:', error);
                debugPanel.textContent = `Error: ${error.message}`;
            }
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function() {
            const searchValue = this.value.toLowerCase();
            displayConnections(allConnections, searchValue);
        });
        
        // Function to message a connection
        function messageConnection(connectionId) {
            const connection = allConnections.find(c => c.id === connectionId);
            if (connection) {
                alert(`Sending message to ${connection.name}.\n\nIn a real application, this would open a LinkedIn message dialog.`);
            }
        }
        
        // Function to view a profile - completely rewritten
        function viewProfile(profileUrl, attendeeId) {
            console.log(`Viewing profile with URL: ${profileUrl} for attendee ID: ${attendeeId}`);
            
            // If no profile URL is available, show an error message
            if (!profileUrl) {
                console.error('No LinkedIn profile URL available for this user');
                alert('LinkedIn profile URL not available for this attendee.');
                return;
            }
            
            try {
                // Get connection details for better search
            const connection = allConnections.find(c => c.id === attendeeId);
                const userName = connection ? connection.name : '';
                const userCompany = connection ? connection.company : '';
                const userTitle = connection ? connection.title : '';
            
                // Handle the URL based on its format
            if (profileUrl.startsWith('search:')) {
                    // Extract the ID for search
                    const searchId = profileUrl.replace('search:', '');
                    console.log(`Using search fallback with ID: ${searchId}`);
                    
                    // Create a better search query using name, company and title if available
                    let searchQuery = '';
                    
                    if (userName) {
                        searchQuery = userName;
                        if (userCompany) {
                            searchQuery += ` ${userCompany}`;
                        }
                        if (userTitle) {
                            searchQuery += ` ${userTitle}`;
                        }
                    } else if (searchId && searchId !== 'unknown') {
                        searchQuery = searchId;
                    } else {
                        searchQuery = 'Conference attendee';
                    }
                    
                    // Search by name and other details via the LinkedIn search page
                    const finalSearchUrl = `https://www.linkedin.com/search/results/all/?keywords=${encodeURIComponent(searchQuery)}`;
                    console.log(`Opening search URL: ${finalSearchUrl}`);
                    window.open(finalSearchUrl, '_blank');
                } else if (profileUrl.includes('linkedin.com')) {
                    // Clean any malformed LinkedIn URLs
                    let cleanUrl = profileUrl;
                    
                    // Remove any @ symbols or other invalid characters
                    cleanUrl = cleanUrl.replace(/^[@]+/, '').replace(/[@#$%^&*()]+/g, '');
                    
                    // Handle LinkedIn URLs with missing https://
                    if (!cleanUrl.startsWith('http')) {
                        cleanUrl = 'https://' + cleanUrl.replace(/^\/\//, '');
                    }
                    
                    // Direct LinkedIn URL - open it directly
                    console.log(`Opening direct LinkedIn URL: ${cleanUrl}`);
                    window.open(cleanUrl, '_blank');
                } else if (profileUrl.startsWith('http')) {
                    // Other URL format but still a valid URL
                    // Clean it first
                    const cleanUrl = profileUrl.replace(/[@#$%^&*()]+/g, '');
                    console.log(`Opening non-LinkedIn URL: ${cleanUrl}`);
                    window.open(cleanUrl, '_blank');
                } else {
                    // If it looks like a LinkedIn username/ID but not a full URL
                    const cleanId = profileUrl.replace(/[^a-zA-Z0-9_-]/g, '');
                    
                    // If it looks like a system ID (all caps/numbers), use search instead
                    if (cleanId.match(/^[A-Z0-9_]{8,}$/)) {
                        // Use name-based search for system IDs
                        const searchQuery = userName || cleanId;
                        console.log(`Using search for system ID: ${cleanId}`);
                        window.open(`https://www.linkedin.com/search/results/all/?keywords=${encodeURIComponent(searchQuery)}`, '_blank');
                    } else {
                        // Otherwise try the direct profile URL
                        console.log(`Converting possible LinkedIn ID to URL: ${cleanId}`);
                        window.open(`https://www.linkedin.com/in/${encodeURIComponent(cleanId)}`, '_blank');
                    }
                }
            } catch (error) {
                console.error('Error opening profile URL:', error);
                alert('Error opening profile: ' + error.message);
            }
        }
        
        // Logout function
        function logout() {
            localStorage.removeItem('isAuthenticated');
            localStorage.removeItem('linkedInUser');
            window.location.href = 'auth.html';
        }
        
        // Function to go to auth page
        function goToAuth() {
            // Create a test conference
            const testConferenceId = 'conf_' + Date.now();
            const testConferenceName = 'Conference ' + new Date().toLocaleDateString();
            const testConferenceLocation = 'Virtual';
            
            // Store in sessionStorage
            sessionStorage.setItem('conferenceId', testConferenceId);
            sessionStorage.setItem('conferenceName', testConferenceName);
            sessionStorage.setItem('conferenceLocation', testConferenceLocation);
            
            // Redirect to auth with parameters
            window.location.href = `auth.html?id=${testConferenceId}&name=${encodeURIComponent(testConferenceName)}&location=${encodeURIComponent(testConferenceLocation)}`;
        }
        
        // Function to bypass auth check
        function bypassAuthCheck() {
            window.location.href = window.location.pathname + '?bypass_auth=true';
        }
        
        // Function to test LinkedIn profile format
        function testLinkedInFormat() {
            // Create a test user profile with the LinkedIn API format
            const testProfile = {
                id: "linkedin_test_user_" + Date.now(),
                firstName: {
                    localized: {
                        en_US: "John"
                    },
                    preferredLocale: {
                        country: "US",
                        language: "en"
                    }
                },
                lastName: {
                    localized: {
                        en_US: "Doe"
                    },
                    preferredLocale: {
                        country: "US",
                        language: "en"
                    }
                },
                profilePicture: {
                    displayImage: "https://randomuser.me/api/portraits/men/1.jpg"
                },
                emailAddress: "john.doe@example.com",
                // Conference information
                conference: {
                    id: "conf_linkedin_test",
                    name: "LinkedIn Test Conference",
                    location: "Virtual Event"
                }
            };
            
            // Save to localStorage
            try {
                localStorage.setItem('linkedInUser', JSON.stringify(testProfile));
                localStorage.setItem('conferenceId', testProfile.conference.id);
                localStorage.setItem('conferenceName', testProfile.conference.name);
                localStorage.setItem('conferenceLocation', testProfile.conference.location);
                localStorage.setItem('isAuthenticated', 'true');
                localStorage.setItem('authTime', new Date().toISOString());
                
                // Log the user ID
                console.log(`Created test user with LinkedIn format. User ID: ${testProfile.id}`);
                alert(`LinkedIn format data set in localStorage.\nUser ID: ${testProfile.id}\nRefreshing page...`);
                
                // Register this user for the conference
                setTimeout(() => {
                    registerForConference()
                        .then(() => refreshPage())
                        .catch(err => {
                            console.error('Error registering test user:', err);
                            refreshPage();
                        });
                }, 500);
            } catch (error) {
                alert('Error setting LinkedIn test data: ' + error.message);
            }
        }
        
        // Function to test LinkedIn OAuth response format
        function testLinkedInOAuth() {
            // Create a test user profile with the LinkedIn OAuth format
            // This is the format we get when using Sign In with LinkedIn OAuth 2.0
            const testProfile = {
                sub: "oauth_test_user_" + Date.now(),
                name: "Jane Doe",
                given_name: "Jane",
                family_name: "Doe",
                picture: "https://randomuser.me/api/portraits/women/10.jpg",
                email: "jane.doe@example.com",
                email_verified: true,
                locale: "en_US",
                // LinkedIn specific fields
                at_hash: "abcdefghijklmnop",
                aud: "12345678",
                exp: 1616239022,
                iat: 1616235422,
                iss: "https://www.linkedin.com",
                jti: "abcdefghijklmnopqrstuvwxyz12345",
                nbf: 1616235422,
                nonce: "abcdefghijklmnopqrstuvwxyz12345",
                // Conference information
                conference: {
                    id: "conf_oidc_test",
                    name: "OAuth Test Conference",
                    location: "Virtual Event"
                }
            };
            
            // Save to localStorage
            try {
                localStorage.setItem('linkedInUser', JSON.stringify(testProfile));
                localStorage.setItem('conferenceId', testProfile.conference.id);
                localStorage.setItem('conferenceName', testProfile.conference.name);
                localStorage.setItem('conferenceLocation', testProfile.conference.location);
                localStorage.setItem('isAuthenticated', 'true');
                localStorage.setItem('authTime', new Date().toISOString());
                
                // Log the user ID
                console.log(`Created test user with OAuth format. User ID (sub): ${testProfile.sub}`);
                alert(`LinkedIn OAuth format data set in localStorage.\nUser ID: ${testProfile.sub}\nRefreshing page...`);
                
                // Register this user for the conference
                setTimeout(() => {
                    registerForConference()
                        .then(() => refreshPage())
                        .catch(err => {
                            console.error('Error registering test user:', err);
                            refreshPage();
                        });
                }, 500);
            } catch (error) {
                alert('Error setting OAuth test data: ' + error.message);
            }
        }
        
        // Update visibility function to use backend
        async function updateVisibility(isVisible) {
            const status = document.getElementById('visibility-status');
            const userData = JSON.parse(localStorage.getItem('linkedInUser'));
            const userId = userData.id;
            const conferenceId = localStorage.getItem('conferenceId');
            
            console.log('Updating visibility:', {
                userId,
                conferenceId,
                isVisible
            });
            
            try {
                // First ensure user is registered for the conference
                const registerResult = await registerForConference();
                console.log('Register result before visibility update:', registerResult);
                
                // Then update visibility status
                const visibilityUrl = '/.netlify/functions/conference-visibility';
                console.log('Updating visibility at URL:', visibilityUrl);
                
                // Build complete user data similar to registration
                let name = userData.name;
                if (!name && (userData.firstName || userData.lastName)) {
                    name = `${userData.firstName || ''} ${userData.lastName || ''}`.trim();
                }
                if (!name && (userData.given_name || userData.family_name)) {
                    name = `${userData.given_name || ''} ${userData.family_name || ''}`.trim();
                }
                
                // Normalize email
                const email = userData.email || userData.emailAddress || 'email@example.com';
                
                // Normalize profile picture
                let profilePicture = userData.profilePicture || userData.pictureUrl || userData.picture;
                if (typeof profilePicture === 'object' && profilePicture?.['displayImage~']?.elements?.[0]?.identifiers?.[0]?.identifier) {
                    profilePicture = profilePicture['displayImage~'].elements[0].identifiers[0].identifier;
                }
                
                const visibilityData = {
                    userId,
                    conferenceId,
                    isVisible,
                    userData: {
                        id: userId,
                        name: name || 'Conference Attendee',
                        email: email,
                        profilePicture: profilePicture || '',
                        headline: userData.headline || userData.title || '',
                        company: userData.company || userData.currentPosition?.companyName || '',
                        title: userData.title || userData.headline || '',
                        // Include LinkedIn URL if available
                        linkedinUrl: userData.linkedinUrl || '',
                        // Include vanity name if available
                        vanityName: userData.vanityName || ''
                    }
                };
                
                const response = await fetch(visibilityUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache, no-store'
                    },
                    body: JSON.stringify(visibilityData)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Visibility update error:', errorText);
                    throw new Error('Failed to update visibility');
                }

                console.log('Successfully updated visibility');
                
                status.textContent = isVisible ? 'Visible to Other Attendees' : 'Hidden from Other Attendees';
                localStorage.setItem('userVisibility', isVisible.toString());
                
                // Update the visibility indicator without affecting the connections list
                const visibilityIndicator = document.createElement('div');
                visibilityIndicator.className = 'visibility-indicator';
                visibilityIndicator.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background-color: ${isVisible ? '#28a745' : '#dc3545'};
                    color: white;
                    padding: 10px 20px;
                    border-radius: 4px;
                    z-index: 1000;
                    animation: fadeOut 3s forwards;
                `;
                visibilityIndicator.textContent = isVisible ? 'You are visible to other attendees' : 'You are hidden from other attendees';
                document.body.appendChild(visibilityIndicator);
                
                // Remove the indicator after animation
                setTimeout(() => visibilityIndicator.remove(), 3000);
                
                // Refresh connections if we're visible now
                if (isVisible) {
                    setTimeout(refreshConnections, 1000);
                }
            } catch (error) {
                console.error('Error updating visibility:', error);
                alert('Failed to update visibility: ' + error.message);
                // Revert the toggle
                document.getElementById('visibility-toggle').checked = !isVisible;
            }
        }

        // Initialize visibility from stored preference
        function initializeVisibility() {
            // Get stored visibility preference, default to visible if not set
            const storedVisibility = localStorage.getItem('userVisibility');
            const isVisible = storedVisibility === null ? true : storedVisibility !== 'false';
            
            // Update the toggle
            const visibilityToggle = document.getElementById('visibility-toggle');
            visibilityToggle.checked = isVisible;
            
            // Update the status text immediately
            const status = document.getElementById('visibility-status');
            status.textContent = isVisible ? 'Visible to Other Attendees' : 'Hidden from Other Attendees';
            
            // Ensure visibility setting is saved
            localStorage.setItem('userVisibility', isVisible.toString());
            
            // Register for conference and update visibility in the background
            registerForConference().catch(error => {
                console.error('Error during initialization:', error);
            });
        }

        // Add CSS for visibility indicator animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeOut {
                0% { opacity: 1; }
                70% { opacity: 1; }
                100% { opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Display user profile data
        function displayUserProfile() {
            // Get user data from localStorage
            const userData = localStorage.getItem('linkedInUser');
            if (!userData) {
                // Redirect to auth page if no user data is found
                window.location.href = 'auth.html';
                return;
            }
            
            try {
                // Parse user data
                const user = JSON.parse(userData);
                
                // Get conference info from localStorage
                const conferenceId = localStorage.getItem('conferenceId') || 'default_conference';
                const conferenceName = localStorage.getItem('conferenceName') || 'Sample Conference';
                const conferenceLocation = localStorage.getItem('conferenceLocation') || 'Virtual Event';
                
                // Store as global variables
                window.conferenceId = conferenceId;
                window.conferenceName = conferenceName;
                
                // Update conference UI
                document.getElementById('conference-name').textContent = conferenceName;
                document.getElementById('conference-location').textContent = conferenceLocation;
                
                // Update user profile info with appropriate fallbacks
                let profileName = user.name;
                if (!profileName && (user.firstName || user.lastName)) {
                    profileName = `${user.firstName || ''} ${user.lastName || ''}`.trim();
                }
                if (!profileName) {
                    profileName = user.id || 'User';
                }
                
                const profileEmail = user.email || 'Email not available';
                
                // Get headline with fallbacks but without using "LinkedIn User" placeholder
                let profileHeadline = '';
                if (user.headline && user.headline !== 'LinkedIn User') {
                    profileHeadline = user.headline;
                } else if (user.currentPosition?.title) {
                    profileHeadline = user.currentPosition.title;
                    if (user.currentPosition.companyName) {
                        profileHeadline += ` at ${user.currentPosition.companyName}`;
                    }
                } else if (user.title) {
                    profileHeadline = user.title;
                } else if (user.company) {
                    profileHeadline = `Professional at ${user.company}`;
                } else {
                    // Leave blank rather than using 'LinkedIn User'
                    profileHeadline = '';
                }
                
                // For the profile picture, try multiple possible paths
                let profilePicture = user.profilePicture;
                if (!profilePicture && user.pictureUrl) {
                    profilePicture = user.pictureUrl;
                }
                if (!profilePicture && user.profilePicture?.['displayImage~']?.elements?.[0]?.identifiers?.[0]?.identifier) {
                    profilePicture = user.profilePicture['displayImage~'].elements[0].identifiers[0].identifier;
                }
                if (!profilePicture) {
                    profilePicture = 'https://randomuser.me/api/portraits/lego/1.jpg';
                }
                
                // Display user profile on the page
                updateProfileUI(profileName, profileEmail, profileHeadline, profilePicture);
                
                // Debug: Display storage information
                displayStorageDebugInfo();
                
            } catch (error) {
                console.error('Error parsing user profile:', error);
                
                // Create fallback values
                const fallbackName = 'Guest User';
                const fallbackEmail = 'guest@example.com';
                const fallbackHeadline = '';
                const fallbackPicture = 'https://randomuser.me/api/portraits/lego/1.jpg';
                
                // Display fallback user profile
                updateProfileUI(fallbackName, fallbackEmail, fallbackHeadline, fallbackPicture);
            }
        }

        // Display debug information in the debug panel
        function displayStorageDebugInfo() {
            const debugElement = document.getElementById('debug-info');
            if (!debugElement) return;
            
            try {
                const userData = JSON.parse(localStorage.getItem('linkedInUser') || '{}');
                const conferenceId = localStorage.getItem('conferenceId') || 'N/A';
                const conferenceName = localStorage.getItem('conferenceName') || 'N/A';
                const userVisible = localStorage.getItem('userVisibility') !== 'false';
                
                // Sanitize user data for display
                const sanitizedUser = { ...userData };
                if (sanitizedUser.profilePicture && sanitizedUser.profilePicture.length > 30) {
                    sanitizedUser.profilePicture = sanitizedUser.profilePicture.substring(0, 30) + '...';
                }
                
                const debugInfo = `
LinkedInUser: ${JSON.stringify(sanitizedUser, null, 2)}
ConferenceId: ${conferenceId}
ConferenceName: ${conferenceName}
UserVisibility: ${userVisible ? 'Visible' : 'Hidden'}
Last Updated: ${new Date().toLocaleTimeString()}
                `;
                
                debugElement.textContent = debugInfo;
            } catch (error) {
                console.error('Error updating debug info:', error);
                debugElement.textContent = 'Error loading debug information';
            }
        }

        // Function to refresh page
        function refreshPage() {
            window.location.reload();
        }

        // Function to clear all data
        function clearAllData() {
            localStorage.clear();
            sessionStorage.clear();
            alert('All local data cleared. The page will now reload.');
            setTimeout(refreshPage, 500);
        }

        // Function to fix test data
        function fixTestData() {
            // Create a valid user profile
            const testUser = {
                id: `test_user_${Date.now()}`,
                firstName: 'Test',
                lastName: 'User',
                name: 'Test User',
                email: 'test@example.com',
                profilePicture: 'https://randomuser.me/api/portraits/people/1.jpg',
                headline: 'Software Developer'
            };
            
            // Store the test data
            localStorage.setItem('linkedInUser', JSON.stringify(testUser));
            localStorage.setItem('isAuthenticated', 'true');
            localStorage.setItem('authTime', new Date().toISOString());
            
            // Set conference data if not already present
            if (!localStorage.getItem('conferenceId')) {
                localStorage.setItem('conferenceId', 'conf_test');
                localStorage.setItem('conferenceName', 'Test Conference');
                localStorage.setItem('conferenceLocation', 'Test Location');
            }
            
            alert('Test data has been set. Refreshing page...');
            setTimeout(refreshPage, 500);
        }

        // Display user profile UI
        function updateProfileUI(profileName, profileEmail, profileHeadline, profileImageUrl) {
            document.getElementById('profile-name').textContent = profileName;
            document.getElementById('profile-email').textContent = profileEmail;
            document.getElementById('profile-headline').textContent = profileHeadline;
            
            // Set profile image with error handling
            const profileImg = document.getElementById('profile-image');
            if (profileImg) {
                profileImg.onerror = function() { 
                    console.warn('Profile image failed to load:', this.src);
                    this.src = 'https://randomuser.me/api/portraits/lego/1.jpg'; 
                };
                profileImg.src = profileImageUrl;
            }
        }

        // Function to share the conference link
        function showShareOptions() {
            const conferenceId = localStorage.getItem('conferenceId');
            const conferenceName = localStorage.getItem('conferenceName');
            const conferenceLocation = localStorage.getItem('conferenceLocation');
            
            // Create URL for sharing
            const shareUrl = `${window.location.origin}/docs/user/auth.html?id=${conferenceId}&name=${encodeURIComponent(conferenceName)}&location=${encodeURIComponent(conferenceLocation || '')}`;
            
            // Create and show sharing dialog
            const dialog = document.createElement('div');
            dialog.className = 'qr-dialog';
            
            dialog.innerHTML = `
                <h3>Share Conference Link</h3>
                <p>Share this link to invite others to join "${conferenceName}":</p>
                <div style="display: flex; margin-bottom: 15px;">
                    <input type="text" value="${shareUrl}" 
                        style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" readonly id="shareUrlInput">
                    <button onclick="copyShareUrl()" style="margin-left: 10px; background: #0077b5; color: white; border: none; border-radius: 4px; padding: 0 15px; cursor: pointer;">
                        Copy
                    </button>
                </div>
                <div class="dialog-buttons">
                    <button onclick="closeDialog()" class="btn btn-outline">
                        Close
                    </button>
                </div>
            `;
            
            // Add the dialog to the body
            document.body.appendChild(dialog);
            
            // Store the dialog element for later reference
            window.currentDialog = dialog;
            
            // Select the URL for easier copying
            setTimeout(() => {
                document.getElementById('shareUrlInput').select();
            }, 100);
        }

        // Function to copy the share URL to clipboard
        function copyShareUrl() {
            const input = document.getElementById('shareUrlInput');
            input.select();
            document.execCommand('copy');
            
            // Show copied indicator
            const copyBtn = input.nextElementSibling;
            const originalText = copyBtn.textContent;
            copyBtn.textContent = 'Copied!';
            
            setTimeout(() => {
                copyBtn.textContent = originalText;
            }, 2000);
        }

        // Function to close the share dialog
        function closeDialog() {
            if (window.currentDialog) {
                document.body.removeChild(window.currentDialog);
                window.currentDialog = null;
            }
        }

        // Function to add a test user directly
        async function directSetTestData() {
            try {
                const conferenceId = localStorage.getItem('conferenceId');
                const currentUser = JSON.parse(localStorage.getItem('linkedInUser'));
                
                // Make sure we have the current user ID
                const currentUserId = currentUser.id || currentUser.sub;
                if (!currentUserId) {
                    alert('Cannot determine current user ID. Please log in again.');
                    return;
                }
                
                // Create a test user with a different ID
                const testUserId = `test_user_${Date.now()}`;
                const testName = `Test User ${new Date().toLocaleTimeString()}`;
                
                // Display info to user
                alert(`Creating test user with ID ${testUserId} and adding to conference ${conferenceId}.\nYour ID is ${currentUserId}`);
                
                // Make a direct request to set the data
                const url = `/.netlify/functions/debug-store?action=set_conference_data&conferenceId=${encodeURIComponent(conferenceId)}&userId=${encodeURIComponent(testUserId)}&name=${encodeURIComponent(testName)}`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('Set test data result:', result);
                
                // Also add the current user to ensure they're visible too
                const currentUserName = currentUser.name || `${currentUser.firstName || ''} ${currentUser.lastName || ''}`.trim() || 'Current User';
                const currentUserUrl = `/.netlify/functions/debug-store?action=set_conference_data&conferenceId=${encodeURIComponent(conferenceId)}&userId=${encodeURIComponent(currentUserId)}&name=${encodeURIComponent(currentUserName)}`;
                
                const currentUserResponse = await fetch(currentUserUrl);
                if (!currentUserResponse.ok) {
                    throw new Error(`Server returned ${currentUserResponse.status}: ${currentUserResponse.statusText} when adding current user`);
                }
                
                const currentUserResult = await currentUserResponse.json();
                console.log('Set current user result:', currentUserResult);
                
                // Wait a moment for data to be saved
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Refresh connections to show the new test user
                refreshConnections();
                
            } catch (error) {
                console.error('Error setting test data:', error);
                alert('Failed to add test user: ' + error.message);
            }
        }

        // Add a function to cleanup test users
        async function cleanupTestUsers() {
            try {
                const conferenceId = localStorage.getItem('conferenceId');
                
                document.getElementById('loadingOverlay').style.display = 'flex';
                
                // Make a direct request to clean up test users
                const url = `/.netlify/functions/debug-store?action=cleanup_test_users&conferenceId=${encodeURIComponent(conferenceId)}`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('Cleanup result:', result);
                
                // Success message
                alert(`Cleaned up ${result.removed || 0} test users. Refreshing data...`);
                
                // Re-register current user
                await registerForConference();
                
                // Wait and refresh
                setTimeout(refreshConnections, 1000);
                
            } catch (error) {
                console.error('Error cleaning up test users:', error);
                alert('Failed to clean up test users: ' + error.message);
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        // Function to process attendees data for display
        function processAttendees(attendees) {
            console.log('Processing attendees for display:', attendees);
            
            // Make sure we have an array of attendees
            if (!Array.isArray(attendees)) {
                console.error('Expected array of attendees but got:', attendees);
                return [];
            }
            
            // Get current user info
            const userData = JSON.parse(localStorage.getItem('linkedInUser'));
            const currentUserId = userData ? (userData.id || userData.sub) : null;
            
            // Process each attendee
            const processedAttendees = attendees.map(attendee => {
                // Log the attendee data for debugging
                console.log('Processing attendee:', attendee);
                
                // Determine the best profile URL for this attendee
                const profileUrl = getBestProfileUrl(attendee);
                
                // Log the final profile URL
                console.log(`Final profile URL for ${attendee.name || 'unnamed'}: ${profileUrl}`);
                
                // If this is a raw database record format
                if (attendee.profile) {
                    return {
                        id: attendee.id || attendee.userId || attendee.profile.id,
                        name: attendee.profile.name || 'Unnamed Attendee',
                        title: attendee.profile.headline || attendee.profile.title || '',
                        company: attendee.profile.company || '',
                        pictureUrl: attendee.profile.profilePicture || attendee.profile.pictureUrl || 'https://randomuser.me/api/portraits/lego/1.jpg',
                        profileUrl: profileUrl,
                        lastActive: Math.floor((Date.now() - new Date(attendee.lastActive || Date.now()).getTime()) / 60000),
                        isCurrentUser: currentUserId && (attendee.id === currentUserId || attendee.profile.id === currentUserId)
                    };
                }
                
                // If this is already in the expected format
                return {
                    id: attendee.id || attendee.userId,
                    name: attendee.name || 'Unnamed Attendee',
                    title: attendee.title || attendee.role || '',
                    company: attendee.company || '',
                    pictureUrl: attendee.pictureUrl || attendee.profilePicture || 'https://randomuser.me/api/portraits/lego/1.jpg',
                    profileUrl: profileUrl,
                    lastActive: typeof attendee.lastActive === 'number' ? attendee.lastActive : 
                        Math.floor((Date.now() - new Date(attendee.lastActive || Date.now()).getTime()) / 60000),
                    isCurrentUser: currentUserId && (attendee.id === currentUserId || attendee.userId === currentUserId)
                };
            });
            
            console.log('Final processed attendees:', processedAttendees);
            return processedAttendees;
        }

        // Add this function to determine the best profile URL format
        function getBestProfileUrl(attendee) {
            const profile = attendee.profile || attendee;
            let profileUrl = '';
            
            console.log(`Finding best profile URL for:`, profile);
            
            // 1. Direct database fields should be highest priority
            if (attendee.linkedinUrl) {
                profileUrl = attendee.linkedinUrl;
                console.log(`Using database linkedinUrl field: ${profileUrl}`);
                return ensureValidLinkedInUrl(profileUrl);
            }
            
            if (profile.linkedinUrl) {
                profileUrl = profile.linkedinUrl;
                console.log(`Using profile linkedinUrl field: ${profileUrl}`);
                return ensureValidLinkedInUrl(profileUrl);
            }
            
            // 2. Check for public profile URL in various formats
            if (profile.publicProfileUrl) {
                profileUrl = profile.publicProfileUrl;
                console.log(`Using public profile URL: ${profileUrl}`);
                return ensureValidLinkedInUrl(profileUrl);
            }
            
            // 3. Check for profile URL
            if (profile.profileUrl) {
                profileUrl = profile.profileUrl;
                console.log(`Using profile URL: ${profileUrl}`);
                return ensureValidLinkedInUrl(profileUrl);
            }
            
            // 4. Check for vanity name that doesn't look like an internal ID
            if (profile.vanityName && !profile.vanityName.match(/^[A-Z0-9_]{8,}$/i)) {
                profileUrl = `https://www.linkedin.com/in/${profile.vanityName}`;
                console.log(`Using vanity name: ${profileUrl}`);
                return ensureValidLinkedInUrl(profileUrl);
            }
            
            // 5. Check for siteStandardProfileRequest URL (from LinkedIn API v1)
            if (profile.siteStandardProfileRequest && profile.siteStandardProfileRequest.url) {
                profileUrl = profile.siteStandardProfileRequest.url;
                console.log(`Using siteStandardProfileRequest URL: ${profileUrl}`);
                return ensureValidLinkedInUrl(profileUrl);
            }
            
            // 6. Check for specific LinkedIn API v2 format
            if (profile.profileUrl && typeof profile.profileUrl === 'object' && profile.profileUrl.elements) {
                const elementUrl = profile.profileUrl.elements[0]?.identifiers[0]?.identifier;
                if (elementUrl) {
                    profileUrl = elementUrl;
                    console.log(`Using LinkedIn API v2 format URL: ${profileUrl}`);
                    return ensureValidLinkedInUrl(profileUrl);
                }
            }
            
            // 7. Try to use the ID if it doesn't look like a system-generated ID
            const id = attendee.id || profile.id;
            if (id) {
                // If it looks like a system-generated ID (all caps/numbers, typically >7 chars), use search instead
                if (id.match(/^[A-Z0-9_]{8,}$/)) {
                    profileUrl = `search:${id}`;
                    console.log(`Using search for system-generated ID: ${profileUrl}`);
                    return profileUrl;
                }
                
                // If it looks like a vanity name or username (has lowercase letters, reasonable length)
                if (id.match(/^[a-zA-Z0-9_-]{5,30}$/) && /[a-z]/.test(id)) {
                    profileUrl = `https://www.linkedin.com/in/${id}`;
                    console.log(`Constructing URL from likely vanity name: ${profileUrl}`);
                    return ensureValidLinkedInUrl(profileUrl);
                }
            }
            
            // 8. Fall back to search by ID
            profileUrl = `search:${id || 'unknown'}`;
            console.log(`Using search fallback: ${profileUrl}`);
            return profileUrl;
        }
        
        // Helper function to ensure a LinkedIn URL is valid
        function ensureValidLinkedInUrl(url) {
            if (!url) return `search:unknown`;
            
            // Clean up the URL - remove any @ symbols or other invalid characters at the start
            url = url.replace(/^[@]+/, '');
            
            // Return as-is if it's already a search format
            if (url.startsWith('search:')) return url;
            
            // If it's a valid URL with linkedin.com, return as-is but ensure it starts with https://
            if (url.includes('linkedin.com')) {
                // Remove any invalid characters
                url = url.replace(/[@#$%^&*()]+/g, '');
                
                // Ensure it starts with https://
                if (!url.startsWith('http')) {
                    url = 'https://' + url.replace(/^\/\//, '');
                }
                return url;
            }
            
            // If it looks like a LinkedIn ID but not a full URL
            if (url.match(/^[a-zA-Z0-9-]{5,30}$/)) {
                // This looks like a LinkedIn ID, but we should check if it seems like a system ID
                if (url.match(/^[A-Z0-9]{8,}$/)) {
                    // This seems to be a system-generated ID, which may not work with the /in/ format
                    // Better to use search in this case
                    return `search:${url}`;
                }
                return `https://www.linkedin.com/in/${url}`;
            }
            
            // If it looks like just a username/ID with potential invalid chars, clean and make it a proper LinkedIn URL
            if (!url.includes('://') && !url.startsWith('/')) {
                // Clean up the ID to ensure it's valid for a URL
                const cleanId = url.replace(/[^a-zA-Z0-9_-]/g, '');
                
                // If it still looks like an ID and not a system-generated one, use it
                if (cleanId && !cleanId.match(/^[A-Z0-9]{8,}$/)) {
                    return `https://www.linkedin.com/in/${cleanId}`;
                } else {
                    // Fall back to search for system-looking IDs
                    return `search:${cleanId || url}`;
                }
            }
            
            // If it's any other URL format, ensure it's clean and return
            if (url.startsWith('http')) {
                return url.replace(/[@#$%^&*()]+/g, '');
            }
            
            // Default to search if nothing else works
            return `search:${url}`;
        }

        // Add a debug function to log all profile URLs in the connections list
        function debugProfileUrls() {
            console.log('All connections:', allConnections);
            
            if (allConnections && allConnections.length > 0) {
                console.log('========== PROFILE URL DEBUG INFO ==========');
                allConnections.forEach(connection => {
                    console.log(`Connection: ${connection.name} (${connection.id})`);
                    console.log(`Profile URL: ${connection.profileUrl}`);
                    
                    // Analyze the URL to detect potential issues
                    let urlStatus = 'OK';
                    let urlType = 'Unknown';
                    
                    if (!connection.profileUrl) {
                        urlStatus = 'MISSING';
                        urlType = 'None';
                    } else if (connection.profileUrl.startsWith('search:')) {
                        urlStatus = 'FALLBACK';
                        urlType = 'Search Fallback';
                    } else if (connection.profileUrl.includes('linkedin.com/in/')) {
                        urlType = 'LinkedIn Profile URL';
                        // Check for common URL issues
                        if (connection.profileUrl.includes(' ') || 
                            connection.profileUrl.includes('"') || 
                            connection.profileUrl.includes("'")) {
                            urlStatus = 'MALFORMED';
                        }
                    } else if (connection.profileUrl.includes('linkedin.com')) {
                        urlType = 'LinkedIn URL (non-profile)';
                    } else if (connection.profileUrl.startsWith('http')) {
                        urlType = 'Non-LinkedIn URL';
                    } else {
                        urlType = 'Unknown Format';
                        urlStatus = 'INVALID';
                    }
                    
                    console.log(`URL Type: ${urlType}`);
                    console.log(`URL Status: ${urlStatus}`);
                    console.log('------------------------------');
                });
                
                // Add summary stats
                const totalConnections = allConnections.length;
                const missingUrls = allConnections.filter(c => !c.profileUrl).length;
                const searchFallbacks = allConnections.filter(c => c.profileUrl && c.profileUrl.startsWith('search:')).length;
                const linkedInProfiles = allConnections.filter(c => c.profileUrl && c.profileUrl.includes('linkedin.com/in/')).length;
                
                console.log('URL Statistics:');
                console.log(`Total Connections: ${totalConnections}`);
                console.log(`LinkedIn Profile URLs: ${linkedInProfiles} (${Math.round(linkedInProfiles/totalConnections*100)}%)`);
                console.log(`Search Fallbacks: ${searchFallbacks} (${Math.round(searchFallbacks/totalConnections*100)}%)`);
                console.log(`Missing URLs: ${missingUrls} (${Math.round(missingUrls/totalConnections*100)}%)`);
                console.log('============================================');
            } else {
                console.log('No connections available to debug profile URLs');
            }
        }

        // Start initialization when the page loads
        document.addEventListener('DOMContentLoaded', initializePage);

        // Function to show QR code for sharing
        function showQRCode() {
            const conferenceId = localStorage.getItem('conferenceId');
            const conferenceName = localStorage.getItem('conferenceName');
            const conferenceLocation = localStorage.getItem('conferenceLocation');
            
            // Create URL for sharing
            const shareUrl = `${window.location.origin}/docs/user/auth.html?id=${conferenceId}&name=${encodeURIComponent(conferenceName)}&location=${encodeURIComponent(conferenceLocation || '')}`;
            
            // Create dialog for QR code
            const dialog = document.createElement('div');
            dialog.className = 'qr-dialog';
            dialog.innerHTML = `
                <h3>Share Conference QR Code</h3>
                <p>Scan this QR code to join "${conferenceName}"</p>
                <div id="qrcode"></div>
                <div class="dialog-buttons">
                    <button onclick="downloadQRImage()" class="btn">
                        <i class="fas fa-download"></i> Save QR
                    </button>
                    <button onclick="closeDialog()" class="btn btn-outline">
                        Close
                    </button>
                </div>
            `;
            
            // Add the dialog to the body
            document.body.appendChild(dialog);
            
            // Store the dialog element for later reference
            window.currentDialog = dialog;
            
            // Generate QR code
            // First check if QRCode library is loaded
            if (typeof QRCode === 'undefined') {
                // Load QRCode.js if not already loaded
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
                script.onload = function() {
                    generateQR(shareUrl);
                };
                document.head.appendChild(script);
            } else {
                generateQR(shareUrl);
            }
        }
        
        // Generate QR code for the dialog
        function generateQR(url) {
            const qrcodeElement = document.getElementById('qrcode');
            if (!qrcodeElement) return;
            
            qrcodeElement.innerHTML = '';
            
            // Generate QR code
            new QRCode(qrcodeElement, {
                text: url,
                width: 256,
                height: 256,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            
            // Store QR data URL for download
            setTimeout(() => {
                const qrImage = qrcodeElement.querySelector('img');
                if (qrImage) {
                    qrImage.setAttribute('alt', 'Conference QR Code');
                    window.qrDataUrl = qrImage.src;
                }
            }, 100);
        }
        
        // Download QR code image
        function downloadQRImage() {
            if (window.qrDataUrl) {
                const conferenceName = localStorage.getItem('conferenceName') || 'conference';
                const a = document.createElement('a');
                a.download = `qr-code-${conferenceName.toLowerCase().replace(/\s+/g, '-')}.png`;
                a.href = window.qrDataUrl;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } else {
                alert('QR code is not ready yet. Please try again in a moment.');
            }
        }
        
        // Close any dialog
        function closeDialog() {
            if (window.currentDialog) {
                document.body.removeChild(window.currentDialog);
                window.currentDialog = null;
            }
        }
    </script>
</body>
</html>
